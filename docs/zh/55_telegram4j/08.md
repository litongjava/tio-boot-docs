# ä½¿ç”¨ telegram-Client

[[toc]]

`telegram-client` æ˜¯åŸºäº `telegram4j-core` å¼€å‘çš„åº“ï¼Œæ—¨åœ¨ç®€åŒ– Telegram æ¶ˆæ¯çš„å¤„ç†ã€‚æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ `telegram-client` æ¥å¤„ç†æ¶ˆæ¯å’Œå‘½ä»¤ï¼ŒåŒ…æ‹¬ä¾èµ–é…ç½®ã€äº‹ä»¶é€‚é…å™¨ã€å‘½ä»¤å¤„ç†ä»¥åŠå®¢æˆ·ç«¯é…ç½®ç­‰å†…å®¹ã€‚

## æ·»åŠ ä¾èµ–

é¦–å…ˆï¼Œåœ¨é¡¹ç›®çš„ `pom.xml` æ–‡ä»¶ä¸­æ·»åŠ  `telegram-client` çš„ä¾èµ–ï¼š

```xml
<dependency>
  <groupId>com.litongjava</groupId>
  <artifactId>telegram-client</artifactId>
  <version>1.0.0</version>
</dependency>
```

## åˆ›å»ºæ¶ˆæ¯åˆ†å‘å™¨

æ¶ˆæ¯åˆ†å‘å™¨è´Ÿè´£å¤„ç†æ”¶åˆ°çš„æ¶ˆæ¯äº‹ä»¶ï¼Œæ ¹æ®æ¶ˆæ¯å†…å®¹æ‰§è¡Œç›¸åº”çš„æ“ä½œå¹¶å‘é€å›å¤ã€‚

```java
package com.litongjava.telegram.bots.dispatcher;

import org.reactivestreams.Publisher;

import com.litongjava.telegram.dispatcher.TelegramMessageDispatcher;

import lombok.extern.slf4j.Slf4j;
import reactor.core.publisher.Mono;
import telegram4j.core.event.domain.message.SendMessageEvent;
import telegram4j.core.object.Message;
import telegram4j.core.object.chat.Chat;
import telegram4j.core.spec.SendMessageSpec;
import telegram4j.core.util.Id;

@Slf4j
public class MyTelegramMessageDispatcher implements TelegramMessageDispatcher {

  /**
   * å¤„ç† SendMessageEventï¼Œæ‰§è¡Œç¿»è¯‘å¹¶å‘é€å›å¤
   *
   * @param event å‘é€æ¶ˆæ¯äº‹ä»¶
   * @return ç¿»è¯‘åçš„æ¶ˆæ¯ Publisher
   */
  public Publisher<? extends Message> dispatch(SendMessageEvent event) {
    // è·å– Chat å¯¹è±¡ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä»æ¶ˆæ¯ä¸­è·å–
    Mono<Chat> chatMono = Mono.justOrEmpty(event.getChat()).switchIfEmpty(event.getMessage().getChat());
    // å¤„ç† Chat å’Œæ¶ˆæ¯å‘é€
    return chatMono.flatMap(chat -> processAndSendMessage(chat, event.getMessage()));
  }

  /**
   * å¤„ç†æ¶ˆæ¯å†…å®¹ï¼Œæ‰§è¡Œç¿»è¯‘å¹¶å‘é€å›å¤
   *
   * @param chat    èŠå¤©å¯¹è±¡
   * @param message åŸå§‹æ¶ˆæ¯å¯¹è±¡
   * @return å¤„ç†åçš„æ¶ˆæ¯ Publisher
   */
  private Mono<Message> processAndSendMessage(Chat chat, Message message) {
    String text = message.getContent();
    log.info("æ¥æ”¶åˆ°æ¶ˆæ¯: {}", text);

    if (text.equals("/get_chat_id")) {
      Id id = chat.getId();
      return chat.sendMessage("Chat ID: " + id.asLong());
    }

    // æ„å»ºå‘é€æ¶ˆæ¯è§„èŒƒï¼Œè¿™é‡Œå¯ä»¥é›†æˆç¿»è¯‘åŠŸèƒ½
    SendMessageSpec messageSpec = SendMessageSpec.of("Hi");

    // å‘é€å›å¤æ¶ˆæ¯
    return chat.sendMessage(messageSpec);
  }
}
```

## å®ç°äº‹ä»¶é€‚é…å™¨

äº‹ä»¶é€‚é…å™¨ç”¨äºç›‘å¬å’Œå¤„ç† Telegram äº‹ä»¶ï¼Œä¾‹å¦‚æ¶ˆæ¯å‘é€å’Œå›è°ƒæŸ¥è¯¢ç­‰ã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å®ç°äº† `MyBotEventAdapter` æ¥å¤„ç†æ¶ˆæ¯äº‹ä»¶ï¼Œå¹¶è¿‡æ»¤æ‰æœºå™¨äººè‡ªèº«å‘é€çš„æ¶ˆæ¯ã€‚

```java
package com.litongjava.telegram.bots.adapter;

import java.util.Optional;

import org.reactivestreams.Publisher;

import com.litongjava.telegram.bots.dispatcher.MyTelegramMessageDispatcher;
import com.litongjava.telegram.dispatcher.TelegramBotEventDispatcher;

import lombok.extern.slf4j.Slf4j;
import reactor.core.publisher.Mono;
import telegram4j.core.event.EventAdapter;
import telegram4j.core.event.domain.inline.CallbackQueryEvent;
import telegram4j.core.event.domain.message.SendMessageEvent;
import telegram4j.core.object.MentionablePeer;
import telegram4j.core.object.chat.Chat;

@Slf4j
public class MyBotEventAdapter extends EventAdapter {

  private final long botId;

  public MyBotEventAdapter(long selfId) {
    this.botId = selfId;
  }

  @Override
  public Publisher<?> onSendMessage(SendMessageEvent event) {
    Optional<MentionablePeer> optionalAuthor = event.getAuthor();
    Optional<Chat> optionalChat = event.getChat();

    // é˜²æ­¢æœºå™¨äººå¤„ç†è‡ªå·±å‘é€çš„æ¶ˆæ¯
    if (optionalAuthor.isEmpty()) {
      log.info("æ¶ˆæ¯å‘é€è€…ä¿¡æ¯ç¼ºå¤±ï¼Œå¯èƒ½æ˜¯æœºå™¨äººè‡ªèº«å‘é€çš„æ¶ˆæ¯ã€‚");
      return Mono.empty();
    }
    if (optionalChat.isEmpty()) {
      log.info("æ¶ˆæ¯ä¿¡æ¯ç¼ºå¤±ï¼Œå¯èƒ½æ˜¯æœºå™¨äººè‡ªèº«å‘é€çš„æ¶ˆæ¯ã€‚");
      return Mono.empty();
    }
    long messageAuthorId = optionalAuthor.get().getId().asLong();
    if (botId == messageAuthorId) {
      log.info("è·å–åˆ°æœºå™¨äººçš„è‡ªèº«æ¶ˆæ¯ï¼Œå¿½ç•¥å¤„ç†ã€‚");
      return Mono.empty();
    }

    // åˆ›å»ºæ¶ˆæ¯åˆ†å‘å™¨å¹¶å¤„ç†äº‹ä»¶
    MyTelegramMessageDispatcher dispatcher = new MyTelegramMessageDispatcher();
    return TelegramBotEventDispatcher.adapt(event, dispatcher);
  }

  @Override
  public Publisher<?> onCallbackQuery(CallbackQueryEvent event) {
    return super.onCallbackQuery(event);
  }
}
```

## å®šä¹‰å‘½ä»¤å¤„ç†å‡½æ•°

å®šä¹‰å…·ä½“çš„å‘½ä»¤å¤„ç†é€»è¾‘ï¼Œä¾‹å¦‚ `/start` å’Œ `/about` å‘½ä»¤ã€‚æ¯ä¸ªå‘½ä»¤å¯¹åº”ä¸€ä¸ªå‡½æ•°ç±»ï¼Œå®ç°ç‰¹å®šçš„åŠŸèƒ½ã€‚

### StartCommandFunction

å¤„ç† `/start` å‘½ä»¤ï¼Œå‘é€æ¬¢è¿ä¿¡æ¯ã€‚

```java
package com.litongjava.telegram.bots.command;

import org.reactivestreams.Publisher;
import reactor.core.publisher.Mono;
import telegram4j.core.event.domain.message.SendMessageEvent;
import telegram4j.core.object.Message;
import telegram4j.core.object.chat.Chat;

public class StartCommandFunction {

  public Publisher<? extends Message> apply(SendMessageEvent event) {
    String welcomeMessage = "ğŸŒ **ç¿»è¯‘æœºå™¨äºº** ğŸŒ\n\nè¿™ä¸ªæœºå™¨äººä½¿ç”¨ GPT æŠ€æœ¯ä¸ºæ‚¨æä¾›é«˜è´¨é‡çš„æ–‡æœ¬ç¿»è¯‘æœåŠ¡ã€‚æ¬¢è¿ä½¿ç”¨ç¿»è¯‘æœºå™¨äººï¼\n\n";

    Mono<Chat> chat = event.getMessage().getChat();
    return chat.flatMap(c -> c.sendMessage(welcomeMessage));
  }
}
```

### AboutUsCommandFunction

å¤„ç† `/about` å‘½ä»¤ï¼Œå‘é€å…³äºæœºå™¨äººçš„ä¿¡æ¯ã€‚

```java
package com.litongjava.telegram.bots.command;

import org.reactivestreams.Publisher;
import reactor.core.publisher.Mono;
import telegram4j.core.event.domain.message.SendMessageEvent;
import telegram4j.core.object.Message;
import telegram4j.core.object.chat.Chat;

public class AboutUsCommandFunction {

  public Publisher<? extends Message> apply(SendMessageEvent event) {
    String aboutMessage = "**å¼€å‘è€…:** Litong Java\n**ç‰ˆæœ¬:** 1.0.0\n\næ„Ÿè°¢æ‚¨ä½¿ç”¨æœ¬æœºå™¨äººï¼";
    Mono<Chat> chat = event.getMessage().getChat();
    return chat.flatMap(c -> c.sendMessage(aboutMessage));
  }
}
```

## é…ç½® Telegram å®¢æˆ·ç«¯

é…ç½®ç±»è´Ÿè´£åˆå§‹åŒ– Telegram å®¢æˆ·ç«¯ï¼Œè®¾ç½®å‘½ä»¤è·¯ç”±ï¼Œå¹¶ç¡®ä¿å®¢æˆ·ç«¯åœ¨æœåŠ¡å™¨å…³é—­æ—¶æ­£ç¡®æ–­å¼€è¿æ¥ã€‚

```java
package com.litongjava.telegram.bots.config;

import java.nio.file.Path;
import java.time.Duration;
import java.util.function.Function;

import com.litongjava.annotation.AConfiguration;
import com.litongjava.annotation.Initialization;
import com.litongjava.telegram.bots.adapter.MyBotEventAdapter;
import com.litongjava.telegram.bots.command.AboutUsCommandFunction;
import com.litongjava.telegram.bots.command.StartCommandFunction;
import com.litongjava.telegram.command.TelegramClient;
import com.litongjava.telegram.command.TelegramCommandRouter;
import com.litongjava.telegram.config.TelegramBotConfig;
import com.litongjava.tio.boot.server.TioBootServer;
import com.litongjava.tio.utils.environment.EnvUtils;

import lombok.extern.slf4j.Slf4j;
import reactor.util.retry.Retry;
import telegram4j.core.MTProtoBootstrap;
import telegram4j.core.MTProtoTelegramClient;
import telegram4j.core.spec.BotCommandScopeSpec;
import telegram4j.mtproto.store.FileStoreLayout;
import telegram4j.mtproto.store.StoreLayoutImpl;

@Slf4j
@AConfiguration
public class MyTelegramBotConfig {

  @Initialization
  public void config() {
    // ä»ç¯å¢ƒå˜é‡è·å– Telegram API é…ç½®ä¿¡æ¯
    int apiId = EnvUtils.getInt("telegram.api.id");
    String apiHash = EnvUtils.getStr("telegram.api.hash");
    String botAuthToken = EnvUtils.getStr("telegram.bot.auth.token");

    String botId = botAuthToken.split(":")[0];
    // åˆ›å»ºå¹¶è¿æ¥ MTProto Telegram å®¢æˆ·ç«¯
    MTProtoBootstrap bootstrap = MTProtoTelegramClient.create(apiId, apiHash, botAuthToken);

    StoreLayoutImpl storeLayoutImpl = new StoreLayoutImpl(Function.identity());
    FileStoreLayout storeLayout = new FileStoreLayout(storeLayoutImpl, Path.of("t4j-bot_" + botId + ".bin"));
    bootstrap.setStoreLayout(storeLayout);

    MTProtoTelegramClient client = bootstrap.connect().block();
    if (client == null) {
      log.error("æ— æ³•è¿æ¥åˆ° Telegram MTProto å®¢æˆ·ç«¯ã€‚");
      return;
    }
    log.info("æˆåŠŸè¿æ¥åˆ° Telegram MTProto å®¢æˆ·ç«¯ã€‚");

    // åˆ é™¤å·²æœ‰çš„å‘½ä»¤
    deleteCommand(client);

    // æ·»åŠ å‘½ä»¤è·¯ç”±
    TelegramCommandRouter.add("start", "Start using the bot", new StartCommandFunction()::apply);
    TelegramCommandRouter.add("about", "About this bot", new AboutUsCommandFunction()::apply);

    // åˆå§‹åŒ–äº‹ä»¶é€‚é…å™¨
    MyBotEventAdapter myBotEventAdapter = new MyBotEventAdapter(apiId);
    new TelegramBotConfig().init(client, apiId, apiHash, botAuthToken, myBotEventAdapter);

    // æ·»åŠ å®¢æˆ·ç«¯åˆ° TelegramClient ç®¡ç†å™¨
    TelegramClient.addClient("translator", client);

    // åœ¨æœåŠ¡å™¨å…³é—­æ—¶ï¼Œæ–­å¼€ Telegram å®¢æˆ·ç«¯è¿æ¥
    HookCan.me().addDestroyMethod(client::disconnect);
  }

  /**
   * åˆ é™¤ç°æœ‰çš„å‘½ä»¤ï¼Œç¡®ä¿å‘½ä»¤è·¯ç”±çš„æ­£ç¡®æ€§
   *
   * @param client MTProto Telegram å®¢æˆ·ç«¯
   */
  private void deleteCommand(MTProtoTelegramClient client) {
    client.resetCommands(BotCommandScopeSpec.of(BotCommandScopeSpec.Type.DEFAULT), "")
        .retryWhen(Retry.backoff(3, Duration.ofSeconds(2)))
        .doOnSuccess(v -> log.info("æˆåŠŸåˆ é™¤ç°æœ‰å‘½ä»¤ï¼"))
        .doOnError(e -> log.error("åˆ é™¤å‘½ä»¤å¤±è´¥ã€‚", e))
        .block();
  }
}
```

### è¯¦ç»†è¯´æ˜

1. **ç¯å¢ƒå˜é‡é…ç½®**ï¼šé€šè¿‡ `EnvUtils` ä»ç¯å¢ƒå˜é‡ä¸­è·å– Telegram API çš„é…ç½®ä¿¡æ¯ï¼ŒåŒ…æ‹¬ `apiId`ã€`apiHash` å’Œ `botAuthToken`ã€‚

2. **åˆ›å»ºå®¢æˆ·ç«¯**ï¼šä½¿ç”¨ `MTProtoBootstrap` åˆ›å»º Telegram å®¢æˆ·ç«¯ï¼Œå¹¶è®¾ç½®å­˜å‚¨å¸ƒå±€ã€‚è¿™é‡Œä½¿ç”¨ `FileStoreLayout` å°†å®¢æˆ·ç«¯æ•°æ®å­˜å‚¨åœ¨æ–‡ä»¶ä¸­ã€‚

3. **è¿æ¥å®¢æˆ·ç«¯**ï¼šè°ƒç”¨ `bootstrap.connect().block()` è¿æ¥ Telegram å®¢æˆ·ç«¯ï¼Œå¹¶æ£€æŸ¥è¿æ¥æ˜¯å¦æˆåŠŸã€‚

4. **å‘½ä»¤ç®¡ç†**ï¼š

   - **åˆ é™¤ç°æœ‰å‘½ä»¤**ï¼šè°ƒç”¨ `deleteCommand` æ–¹æ³•ï¼Œç¡®ä¿ä¹‹å‰è®¾ç½®çš„å‘½ä»¤è¢«æ¸…é™¤ï¼Œé¿å…å‘½ä»¤å†²çªã€‚
   - **æ·»åŠ æ–°å‘½ä»¤**ï¼šé€šè¿‡ `TelegramCommandRouter` æ·»åŠ  `/start` å’Œ `/about` å‘½ä»¤ï¼Œå¹¶ç»‘å®šå¯¹åº”çš„å¤„ç†å‡½æ•°ã€‚

5. **åˆå§‹åŒ–äº‹ä»¶é€‚é…å™¨**ï¼šåˆ›å»º `MyBotEventAdapter` å®ä¾‹ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™ `TelegramBotConfig` è¿›è¡Œåˆå§‹åŒ–ã€‚

6. **ç®¡ç†å®¢æˆ·ç«¯**ï¼šå°†åˆ›å»ºçš„å®¢æˆ·ç«¯æ·»åŠ åˆ° `TelegramClient` ç®¡ç†å™¨ä¸­ï¼Œä»¥ä¾¿åœ¨éœ€è¦æ—¶è¿›è¡Œç®¡ç†å’Œä½¿ç”¨ã€‚

7. **æ–­å¼€è¿æ¥**ï¼šé€šè¿‡ `HookCan.me().addDestroyMethod(client::disconnect)` ç¡®ä¿åœ¨æœåŠ¡å™¨å…³é—­æ—¶ï¼ŒTelegram å®¢æˆ·ç«¯èƒ½å¤Ÿæ­£ç¡®æ–­å¼€è¿æ¥ï¼Œé‡Šæ”¾èµ„æºã€‚

## æ€»ç»“

æœ¬æ–‡ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨ `telegram-client` åº“æ¥ç®€åŒ– Telegram æœºå™¨äººçš„å¼€å‘è¿‡ç¨‹ã€‚é€šè¿‡æ·»åŠ ä¾èµ–ã€åˆ›å»ºæ¶ˆæ¯åˆ†å‘å™¨ã€å®ç°äº‹ä»¶é€‚é…å™¨ã€å®šä¹‰å‘½ä»¤å¤„ç†å‡½æ•°ä»¥åŠé…ç½® Telegram å®¢æˆ·ç«¯ï¼Œæ‚¨å¯ä»¥å¿«é€Ÿæ­å»ºä¸€ä¸ªåŠŸèƒ½å®Œå–„çš„ Telegram æœºå™¨äººã€‚ä¸Šè¿°ç¤ºä¾‹ä»£ç å±•ç¤ºäº†åŸºæœ¬çš„æ¶ˆæ¯å¤„ç†å’Œå‘½ä»¤å“åº”é€»è¾‘ï¼Œæ‚¨å¯ä»¥æ ¹æ®éœ€æ±‚è¿›è¡Œæ‰©å±•å’Œå®šåˆ¶ï¼Œä»¥å®ç°æ›´å¤æ‚çš„åŠŸèƒ½ã€‚
