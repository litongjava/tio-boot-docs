# 模拟测试

## 命令行

### 核心交互流程 (Telnet 测试脚本)

**前提：** 假设你的 IMAP 服务器运行在 `127.0.0.1` 的 `143` 端口上。如果端口不同，请相应修改。

**打开终端，输入：**
`telnet 127.0.0.1 143`

连接成功后，你应该会看到服务器的欢迎信息，比如 `* OK tio-mail-wing IMAP server ready.`。然后，你就可以开始**手动输入**下面的每一行命令了。

**注意：**
*   每一行 `C:` 开头的都是你需要**输入并按回车**的命令。
*   每一行 `S:` 开头的是你**期望**从服务器看到的响应（基于我们之前的代码修改）。
*   `A001`, `A002`... 是命令标签，你可以随便用，只要不重复就行。
*   `dXNlcjFAdGlvLmNvbQ==` 是 `user1@tio.com` 的 Base64 编码。
*   `MDAwMDAwMDA=` 是 `pass1` 的 Base64 编码。

---

#### **测试脚本开始**

**第1步：连接与能力探测**

```
C: A001 CAPABILITY
```
*   **期望的服务器响应 (S):**
    ```
    * CAPABILITY IMAP4rev1 AUTH=LOGIN IDLE UIDPLUS ID LITERAL+
    A001 OK CAPABILITY completed.
    ```

**第2步：认证**

```
C: A002 AUTHENTICATE LOGIN
```
*   **期望的服务器响应 (S):**
    ```
    + V... (一个代表 "Username:" 的Base64字符串)
    ```
*   **输入你的用户名 (Base64编码):**
    ```
    C: dXNlcjFAdGlvLmNvbQ==
    ```
*   **期望的服务器响应 (S):**
    ```
    + U... (一个代表 "Password:" 的Base64字符串)
    ```
*   **输入你的密码 (Base64编码):**
    ```
    C: MDAwMDAwMDA=
    ```
*   **期望的服务器响应 (S):**
    ```
    A002 OK AUTHENTICATE completed.
    ```

**第3步：交换身份信息**

```
C: A003 ID ("name" "Telnet Client" "version" "1.0")
```
*   **期望的服务器响应 (S):**
    ```
    * ID ("name" "tio-mail-wing")
    A003 OK ID completed.
    ```

**第4步：列出所有文件夹 (检查文件夹结构)**

```
C: A004 LIST "" "*"
```
*   **期望的服务器响应 (S):**
    ```
    * LIST (\HasNoChildren) "/" INBOX
    A004 OK LIST completed.
    ```
    *(如果你实现了其他文件夹，这里也会列出来)*

**第5步：检查是否存在 "Trash" (废纸篓) 文件夹**

```
C: A005 LIST "" "Trash"
```
*   **期望的服务器响应 (S):**
    *   如果你的 `handleList` 总是只返回 `INBOX`，那么这里可能不会有 `* LIST` 响应，只会有一个 `OK`。这可能会让 Thunderbird 决定下一步去 `CREATE` 它。
    ```
    * LIST (\HasNoChildren) "/" INBOX
    A005 OK LIST completed.
    ```
    *(一个更完善的实现应该能根据请求的文件夹名返回结果)*

**第6步：尝试创建 "Trash" 文件夹 (如果上一步没找到)**

```
C: A006 CREATE "Trash"
```
*   **期望的服务器响应 (S):**
    ```
    A006 OK CREATE completed.
    ```
    *(你的模拟实现总是返回成功)*

**第7步：选择 INBOX (这是最关键的一步！)**

```
C: A007 SELECT "Inbox"
```
*   **期望的服务器响应 (S):**
    ```
    * FLAGS (\Answered \Flagged \Deleted \Seen \Draft)
    * OK [PERMANENTFLAGS (\Answered \Flagged \Deleted \Seen \Draft \*)] Flags permitted.
    * 2 EXISTS
    * 1 RECENT
    * OK [UIDVALIDITY 2] UIDs valid.
    * OK [UIDNEXT 100101] Predicted next UID.
    A007 OK [READ-WRITE] SELECT completed.
    ```
    *(这里的 `EXISTS`, `RECENT`, `UNSEEN`, `UIDNEXT` 的具体数值会根据你 `MailboxService` 里的实际数据而变化)*

**第8步：获取新邮件的标志 (可选，但常见)**

```
C: A008 UID FETCH 1:* (FLAGS)
```
*   **期望的服务器响应 (S):**
    ```
    * 1 FETCH (UID 1 FLAGS (\Recent))
    * 2 FETCH (UID 2 FLAGS (\Recent))
    A008 OK FETCH completed.
    ```
    *(假设你有两封邮件，并且它们的UID和标志如上)*

```
C: A009 UID fetch 2 (UID RFC822.SIZE FLAGS BODY.PEEK[HEADER.FIELDS (From To Cc Bcc Subject Date Message-ID Priority X-Priority References Newsgroups In-Reply-To Content-Type Reply-To)])
```

```
C: 55 UID fetch 2 (UID RFC822.SIZE BODY.PEEK[])
```
**第11步：登出**

```
C: A011 LOGOUT
```
*   **期望的服务器响应 (S):**
    ```
    * BYE tio-mail-wing IMAP server signing off
    A011 OK LOGOUT
    ```
    *(服务器随后会关闭连接)*

---

### curl
#### FETCH
```
curl -v \
  --url "imap://192.168.3.8/INBOX" \
  --user "user1@tio.com:00000000" \
  --request 'UID fetch 1:* (FLAGS)'
```

#### 获取邮件头
```curl
curl -v \
  --url "imap://192.168.3.8/INBOX" \
  --user "user1@tio.com:00000000" \
  --request 'UID FETCH 2 (UID RFC822.SIZE FLAGS BODY.PEEK[HEADER.FIELDS (From To Cc Bcc Subject Date Message-ID Priority X-Priority References Newsgroups In-Reply-To Content-Type Reply-To)])'
```

response
```
* Connected to 192.168.3.8 (192.168.3.8) port 143 (#0)
< * OK tio-mail-wing IMAP4rev1 server ready 
> A001 CAPABILITY
< * CAPABILITY IMAP4rev1 AUTH=LOGIN IDLE UIDPLUS ID LITERAL+
< A001 OK CAPABILITY
> A002 AUTHENTICATE LOGIN
< + VXNlcm5hbWU6
> dXNlcjFAdGlvLmNvbQ==
< + UGFzc3dvcmQ6
> MDAwMDAwMDA=
< A002 OK AUTHENTICATE completed.
> A003 SELECT INBOX
< * FLAGS (\Answered \Flagged \Deleted \Seen \Draft)
< * OK [PERMANENTFLAGS (\Answered \Flagged \Deleted \Seen \Draft \*)] Flags permitted.
< * 1 EXISTS
< * 0 RECENT
< * OK [UIDVALIDITY 3] UIDs valid.
< * OK [UIDNEXT 100101] Predicted next UID.
< A003 OK [READ-WRITE] SELECT completed.
> A004 UID FETCH 2 (UID RFC822.SIZE FLAGS BODY.PEEK[HEADER.FIELDS (From To Cc Bcc Subject Date Message-ID Priority X-Priority References Newsgroups In-Reply-To Content-Type Reply-To)])
< * 1 FETCH (UID 2 RFC822.SIZE 345 FLAGS (\Seen) BODY[HEADER.FIELDS (FROM TO CC BCC SUBJECT DATE MESSAGE-ID PRIORITY X-PRIORITY REFERENCES NEWSGROUPS IN-REPLY-TO CONTENT-TYPE REPLY-TO)] {230}
* 1 FETCH (UID 2 RFC822.SIZE 345 FLAGS (\Seen) BODY[HEADER.FIELDS (FROM TO CC BCC SUBJECT DATE MESSAGE-ID PRIORITY X-PRIORITY REFERENCES NEWSGROUPS IN-REPLY-TO CONTENT-TYPE REPLY-TO)] {230}
< Message-ID: <157dc58f-fa68-4420-a6ee-5df03682db72@localdomain>
< Date: Mon, 23 Jun 2025 09:06:36 -1000
< To: bob@localdomain
< From: alice <alice@localdomain>
< Subject: Work
< Content-Type: text/plain; charset=UTF-8; format=flowed
<  {230}
< Message-ID: <157dc58f-fa68-4420-a6ee-5df03682db72@localdomain>
< Date: Mon, 23 Jun 2025 09:06:36 -1000
< To: bob@localdomain
< From: alice <alice@localdomain>
< Subject: Work
< Content-Type: text/plain; charset=UTF-8; format=flowed
< 
< )
< A004 OK FETCH completed
```
#### 获取邮件体
```curl
curl -v \
  --url "imap://192.168.3.8/INBOX" \
  --user "user1@tio.com:00000000" \
  --request 'UID fetch 2 (UID RFC822.SIZE BODY[])'
```
response
```
< * OK tio-mail-wing IMAP4rev1 server ready 
> A001 CAPABILITY
< * CAPABILITY IMAP4rev1 AUTH=LOGIN IDLE UIDPLUS ID LITERAL+
< A001 OK CAPABILITY
> A002 AUTHENTICATE LOGIN
< + VXNlcm5hbWU6
> dXNlcjFAdGlvLmNvbQ==
< + UGFzc3dvcmQ6
> MDAwMDAwMDA=
< A002 OK AUTHENTICATE completed.
> A003 SELECT INBOX
< * FLAGS (\Answered \Flagged \Deleted \Seen \Draft)
< * OK [PERMANENTFLAGS (\Answered \Flagged \Deleted \Seen \Draft \*)] Flags permitted.
< * 1 EXISTS
< * 0 RECENT
< * OK [UIDVALIDITY 3] UIDs valid.
< * OK [UIDNEXT 100101] Predicted next UID.
< A003 OK [READ-WRITE] SELECT completed.
> A004 UID fetch 2 (UID RFC822.SIZE BODY[])
< * 1 FETCH (UID 2 RFC822.SIZE 3451 BODY[] {621}
* 1 FETCH (UID 2 RFC822.SIZE 3451 BODY[] {621}
< Return-Path: <alice@localdomain>
< X-Original-To: bob@localdomain
< Delivered-To: bob@localdomain
< Received: from [192.168.3.8] (unknown [192.168.3.8])
<   by mail.localdomain (Postfix) with ESMTPA id 41C156C5451
<   for <bob@localdomain>; Mon, 23 Jun 2025 09:07:05 -1000 (HST)
< Message-ID: <157dc58f-fa68-4420-a6ee-5df03682db72@localdomain>
< Date: Mon, 23 Jun 2025 09:06:36 -1000
< MIME-Version: 1.0
< User-Agent: Mozilla Thunderbird
< Content-Language: en-US
< To: bob@localdomain
< From: alice <alice@localdomain>
< Subject: Work
< Content-Type: text/plain; charset=UTF-8; format=flowed
< Content-Transfer-Encoding: 7bit
< 
< work
< 
< )
< A004 OK FETCH completed.
```