# 模拟测试

## 命令行

### 核心交互流程 (Telnet 测试脚本)

**前提：** 假设你的 IMAP 服务器运行在 `127.0.0.1` 的 `143` 端口上。如果端口不同，请相应修改。

**打开终端，输入：**
`telnet 127.0.0.1 143`

连接成功后，你应该会看到服务器的欢迎信息，比如 `* OK tio-mail-wing IMAP server ready.`。然后，你就可以开始**手动输入**下面的每一行命令了。

**注意：**
*   每一行 `C:` 开头的都是你需要**输入并按回车**的命令。
*   每一行 `S:` 开头的是你**期望**从服务器看到的响应（基于我们之前的代码修改）。
*   `A001`, `A002`... 是命令标签，你可以随便用，只要不重复就行。
*   `dXNlcjFAdGlvLmNvbQ==` 是 `user1@tio.com` 的 Base64 编码。
*   `cGFzczE=` 是 `pass1` 的 Base64 编码。

---

#### **测试脚本开始**

**第1步：连接与能力探测**

```
C: A001 CAPABILITY
```
*   **期望的服务器响应 (S):**
    ```
    * CAPABILITY IMAP4rev1 AUTH=LOGIN IDLE UIDPLUS ID LITERAL+
    A001 OK CAPABILITY completed.
    ```

**第2步：认证**

```
C: A002 AUTHENTICATE LOGIN
```
*   **期望的服务器响应 (S):**
    ```
    + V... (一个代表 "Username:" 的Base64字符串)
    ```
*   **输入你的用户名 (Base64编码):**
    ```
    C: dXNlcjFAdGlvLmNvbQ==
    ```
*   **期望的服务器响应 (S):**
    ```
    + U... (一个代表 "Password:" 的Base64字符串)
    ```
*   **输入你的密码 (Base64编码):**
    ```
    C: cGFzczE=
    ```
*   **期望的服务器响应 (S):**
    ```
    A002 OK AUTHENTICATE completed.
    ```

**第3步：交换身份信息**

```
C: A003 ID ("name" "Telnet Client" "version" "1.0")
```
*   **期望的服务器响应 (S):**
    ```
    * ID ("name" "tio-mail-wing")
    A003 OK ID completed.
    ```

**第4步：列出所有文件夹 (检查文件夹结构)**

```
C: A004 LIST "" "*"
```
*   **期望的服务器响应 (S):**
    ```
    * LIST (\HasNoChildren) "/" INBOX
    A004 OK LIST completed.
    ```
    *(如果你实现了其他文件夹，这里也会列出来)*

**第5步：检查是否存在 "Trash" (废纸篓) 文件夹**

```
C: A005 LIST "" "Trash"
```
*   **期望的服务器响应 (S):**
    *   如果你的 `handleList` 总是只返回 `INBOX`，那么这里可能不会有 `* LIST` 响应，只会有一个 `OK`。这可能会让 Thunderbird 决定下一步去 `CREATE` 它。
    ```
    * LIST (\HasNoChildren) "/" INBOX
    A005 OK LIST completed.
    ```
    *(一个更完善的实现应该能根据请求的文件夹名返回结果)*

**第6步：尝试创建 "Trash" 文件夹 (如果上一步没找到)**

```
C: A006 CREATE "Trash"
```
*   **期望的服务器响应 (S):**
    ```
    A006 OK CREATE completed.
    ```
    *(你的模拟实现总是返回成功)*

**第7步：选择 INBOX (这是最关键的一步！)**

```
C: A007 SELECT "INBOX"
```
*   **期望的服务器响应 (S):**
    ```
    * FLAGS (\Answered \Flagged \Deleted \Seen \Draft)
    * OK [PERMANENTFLAGS (\Answered \Flagged \Deleted \Seen \Draft \*)] Flags permitted.
    * 2 EXISTS
    * 1 RECENT
    * OK [UIDVALIDITY 1234567890] UIDs valid.
    * OK [UIDNEXT 3] Predicted next UID.
    A007 OK [READ-WRITE] SELECT completed.
    ```
    *(这里的 `EXISTS`, `RECENT`, `UNSEEN`, `UIDNEXT` 的具体数值会根据你 `MailboxService` 里的实际数据而变化)*

**第8步：获取新邮件的标志 (可选，但常见)**

```
C: A008 UID FETCH 1:* (FLAGS)
```
*   **期望的服务器响应 (S):**
    ```
    * 1 FETCH (UID 1 FLAGS (\Recent))
    * 2 FETCH (UID 2 FLAGS (\Recent))
    A008 OK FETCH completed.
    ```
    *(假设你有两封邮件，并且它们的UID和标志如上)*

```
C: A009 UID fetch 1:2 (UID RFC822.SIZE FLAGS BODY.PEEK[HEADER.FIELDS (From To Cc Bcc Subject Date Message-ID Priority X-Priority References Newsgroups In-Reply-To Content-Type Reply-To)])
```
**第11步：登出**

```
C: A011 LOGOUT
```
*   **期望的服务器响应 (S):**
    ```
    * BYE tio-mail-wing IMAP server signing off
    A011 OK LOGOUT
    ```
    *(服务器随后会关闭连接)*

---

### 如何使用这个脚本进行调试

1.  **启动你的服务器。**
2.  **打开 `telnet`。**
3.  **逐行复制粘贴** `C:` 开头的命令到 `telnet` 窗口，然后按回车。
4.  **仔细观察** 你的服务器返回的实际内容。
5.  **对比** 你的实际返回和上面列出的“期望的服务器响应”。

**重点检查 `A007 SELECT "INBOX"` 的响应！** 这是最容易出问题的地方。确保你的服务器返回了所有必要的 `OK [...]` 代码，特别是 `UIDVALIDITY` 和 `UIDNEXT`。任何一个缺失或格式错误都可能导致 Thunderbird 无法正常工作。

通过这个手动测试，你就能像一个侦探一样，精确地看到你的服务器在哪个环节的响应与标准实现有偏差，从而找到并修复问题。