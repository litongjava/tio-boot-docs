# IMAP 邮件协议

## 查询邮件
```
* OK [CAPABILITY IMAP4rev1 SASL-IR LOGIN-REFERRALS ID ENABLE IDLE LITERAL+ AUTH=PLAIN AUTH=LOGIN] Dovecot (Debian) ready.

41 authenticate PLAIN

+ 

AGJvYgAwMDAwMDAwMA==

41 OK [CAPABILITY IMAP4rev1 SASL-IR LOGIN-REFERRALS ID ENABLE IDLE SORT SORT=DISPLAY THREAD=REFERENCES THREAD=REFS THREAD=ORDEREDSUBJECT MULTIAPPEND URL-PARTIAL CATENATE UNSELECT CHILDREN NAMESPACE UIDPLUS LIST-EXTENDED I18NLEVEL=1 CONDSTORE QRESYNC ESEARCH ESORT SEARCHRES WITHIN CONTEXT=SEARCH LIST-STATUS BINARY MOVE SNIPPET=FUZZY PREVIEW=FUZZY PREVIEW STATUS=SIZE SAVEDATE LITERAL+ NOTIFY SPECIAL-USE] Logged in

42 ID ("name" "Thunderbird" "version" "139.0.2")

* ID ("name" "Dovecot")
42 OK ID completed (0.001 + 0.000 secs).

43 select "INBOX"

* FLAGS (\Answered \Flagged \Deleted \Seen \Draft)
* OK [PERMANENTFLAGS (\Answered \Flagged \Deleted \Seen \Draft \*)] Flags permitted.
* 1 EXISTS
* 0 RECENT
* OK [UIDVALIDITY 1750701677] UIDs valid
* OK [UIDNEXT 2] Predicted next UID
43 OK [READ-WRITE] Select completed (0.001 + 0.000 secs).

44 UID fetch 1:* (FLAGS)

* 1 FETCH (UID 1 FLAGS (\Seen))
44 OK Fetch completed (0.001 + 0.000 secs).

45 IDLE

+ idling

DONE

45 OK Idle completed (0.012 + 0.012 + 0.011 secs).

46 noop

46 OK NOOP completed (0.001 + 0.000 secs).

47 UID fetch 2:* (FLAGS)

* 1 FETCH (UID 1 FLAGS (\Seen))
47 OK Fetch completed (0.001 + 0.000 secs).

48 IDLE

+ idling
* OK Still here

DONE

48 OK Idle completed (16.021 + 16.020 + 16.020 secs).

49 noop

49 OK NOOP completed (0.001 + 0.000 secs).

50 UID fetch 2:* (FLAGS)

* 1 FETCH (UID 1 FLAGS (\Seen))
50 OK Fetch completed (0.001 + 0.000 secs).

51 IDLE

+ idling
* 2 EXISTS
* 1 RECENT

DONE

51 OK Idle completed (0.004 + 0.002 + 0.003 secs).

52 noop

52 OK NOOP completed (0.001 + 0.000 secs).

53 UID fetch 2:* (FLAGS)

* 2 FETCH (UID 2 FLAGS (\Recent))
53 OK Fetch completed (0.001 + 0.000 secs).

54 UID fetch 2 (UID RFC822.SIZE FLAGS BODY.PEEK[HEADER.FIELDS (From To Cc Bcc Subject Date Message-ID Priority X-Priority References Newsgroups In-Reply-To Content-Type Reply-To)])

* 2 FETCH (UID 2 RFC822.SIZE 621 FLAGS (\Recent) BODY[HEADER.FIELDS (FROM TO CC BCC SUBJECT DATE MESSAGE-ID PRIORITY X-PRIORITY REFERENCES NEWSGROUPS IN-REPLY-TO CONTENT-TYPE REPLY-TO)] {230}
Message-ID: <157dc58f-fa68-4420-a6ee-5df03682db72@localdomain>
Date: Mon, 23 Jun 2025 09:06:36 -1000
To: bob@localdomain
From: alice <alice@localdomain>
Subject: Work
Content-Type: text/plain; charset=UTF-8; format=flowed

)
54 OK Fetch completed (0.002 + 0.000 + 0.001 secs).

55 UID fetch 2 (UID RFC822.SIZE BODY.PEEK[])

* 2 FETCH (UID 2 RFC822.SIZE 621 BODY[] {621}
Return-Path: <alice@localdomain>
X-Original-To: bob@localdomain
Delivered-To: bob@localdomain
Received: from [192.168.3.8] (unknown [192.168.3.8])
	by mail.localdomain (Postfix) with ESMTPA id 41C156C5451
	for <bob@localdomain>; Mon, 23 Jun 2025 09:07:05 -1000 (HST)
Message-ID: <157dc58f-fa68-4420-a6ee-5df03682db72@localdomain>
Date: Mon, 23 Jun 2025 09:06:36 -1000
MIME-Version: 1.0
User-Agent: Mozilla Thunderbird
Content-Language: en-US
To: bob@localdomain
From: alice <alice@localdomain>
Subject: Work
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit

work

)
55 OK Fetch completed (0.001 + 0.000 secs).

56 UID fetch 2 (UID BODY.PEEK[HEADER.FIELDS (Content-Type Content-Transfer-Encoding)] BODY.PEEK[TEXT]<0.2048>)

* 2 FETCH (UID 2 BODY[HEADER.FIELDS (CONTENT-TYPE CONTENT-TRANSFER-ENCODING)] {91}
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit

 BODY[TEXT]<0> {8}
work

)
56 OK Fetch completed (0.001 + 0.000 secs).

57 IDLE

+ idling

DONE

57 OK Idle completed (0.131 + 0.131 + 0.131 secs).

58 noop

58 OK NOOP completed (0.001 + 0.000 secs).

59 UID fetch 3:* (FLAGS)

* 2 FETCH (UID 2 FLAGS (\Recent))
59 OK Fetch completed (0.001 + 0.000 secs).

60 uid store 2 +Flags (\Seen)

* 2 FETCH (UID 2 FLAGS (\Seen \Recent))
60 OK Store completed (0.001 + 0.000 secs).

61 IDLE

+ idling

```

这份抓包数据记录了一个典型的 IMAP 客户端（Thunderbird）与 IMAP 服务器（Dovecot）的交互过程。整个过程可以概括为：**登录 -> 选择邮箱 -> 等待新邮件 -> 新邮件到达 -> 获取邮件摘要 -> 获取邮件全文 -> 将邮件标记为已读**。

### 整体流程分析

1.  **连接与认证 (到 41 行)**
    *   服务器（Dovecot）宣告自己已准备就绪，并列出其能力（`CAPABILITY`），如支持的认证方式 `AUTH=PLAIN`。
    *   客户端（Thunderbird）使用 `PLAIN` 方式进行认证，发送了 Base64 编码的用户名和密码。
    *   `AGJvYgAwMDAwMDAwMA==` 解码后是 `\0bob\000000000`，表示用户名为 `bob`，密码为 `00000000`。
    *   服务器确认登录成功，并返回了更详细的能力列表。

2.  **选择邮箱与初始状态检查 (42 - 50 行)**
    *   客户端使用 `ID` 命令表明自己的身份是 Thunderbird。
    *   客户端使用 `select "INBOX"` 命令打开收件箱。
    *   服务器响应，告知收件箱中有 `1 EXISTS` (1封邮件)，`0 RECENT` (0封新邮件)，并提供了 `UIDVALIDITY` 和 `UIDNEXT`。
    *   客户端使用 `UID fetch 1:* (FLAGS)` 获取所有邮件的标志（当时只有 UID 为 1 的邮件）。
    *   客户端多次进入 `IDLE` 状态，这是一种节能模式，让客户端可以被动等待服务器的通知（比如新邮件到达），而不需要频繁轮询。

3.  **新邮件到达 (51 - 53 行)**
    *   在一次 `IDLE` 期间，服务器主动推送了 `* 2 EXISTS` 和 `* 1 RECENT`。这**是关键事件**：服务器在通知客户端，现在邮箱里有2封邮件了，其中1封是新的。
    *   客户端退出 `IDLE` 状态，并立刻使用 `UID fetch 2:* (FLAGS)` 来查询这封新邮件（UID 从 2 开始）的标志。
    *   服务器响应，告知 UID 为 2 的邮件标志是 `\Recent`（表示是新邮件，尚未被客户端操作过）。

---

### 重点解释：54 号请求与响应

这是整个交互中最关键的一步之一。在得知有新邮件后，客户端需要获取这封邮件的**摘要信息**，以便在邮件列表中显示（比如发件人、主题、日期等）。

#### **请求: `54 UID fetch 2 (UID RFC822.SIZE FLAGS BODY.PEEK[HEADER.FIELDS (...)])`**

我们来逐一分解这个命令：

*   `54`: 命令的唯一标签（Tag），用于将响应与请求对应起来。
*   `UID fetch`: 命令本身。`fetch` 是获取邮件数据，`UID` 表示后面的 `2` 是邮件的唯一标识符（Unique ID），而不是序列号。使用 UID 的好处是它在会话之间保持不变。
*   `2`: 要操作的邮件的 UID。
*   `( ... )`: 括号内是要获取的数据项列表。
    *   `UID`: 获取邮件的 UID（虽然我们已经用它来指定邮件了，但包含在结果里很方便）。
    *   `RFC822.SIZE`: 获取邮件的完整大小（单位：字节）。这对于显示附件大小或下载进度条很有用。
    *   `FLAGS`: 获取邮件的当前标志（如 `\Seen`, `\Answered`, `\Recent` 等）。
    *   `BODY.PEEK[HEADER.FIELDS (...)]`: 这是最核心的部分。
        *   `BODY`: 表示要获取邮件正文（message body）的部分。在 RFC 标准中，"body" 可以指整个邮件，包括头和体。
        *   `PEEK`: 这是一个非常重要的修饰符。它告诉服务器，在获取数据后，**不要**自动将邮件标记为已读（即不要设置 `\Seen` 标志）。如果用的是 `BODY[]` 而不是 `BODY.PEEK[]`，服务器在返回数据后会自动给邮件加上 `\Seen` 标志。
        *   `[HEADER.FIELDS (...)]`: 这进一步精确了要获取 `BODY` 的哪一部分。它表示“我不要整个邮件，我只要邮件头（Header）中的特定字段”。
        *   `(From To Cc ... Reply-To)`: 这是客户端感兴趣的具体邮件头字段列表。

**总结请求 54 的意图**：
“你好服务器，请给我 UID 为 2 的这封邮件的以下信息：它的 UID、总大小、所有标志，以及它的发件人、收件人、主题、日期等关键头部信息。**请注意，我只是‘偷看’（PEEK）一下，不要把它标记为已读。**”

#### **响应: `* 2 FETCH (...)`**

*   `* 2 FETCH`: 服务器的非标记响应（untagged response），表示这是关于 UID 为 2 的邮件的 `FETCH` 结果。
*   `UID 2`: 邮件的 UID。
*   `RFC822.SIZE 621`: 邮件总大小为 621 字节。
*   `FLAGS (\Recent)`: 邮件的标志是 `\Recent`。注意，没有 `\Seen`，因为客户端用了 `PEEK`。
*   `BODY[HEADER.FIELDS (...)] {230}`: 服务器说：“好的，这是你请求的那些邮件头，接下来的数据长度是 230 字节。”
*   `Message-ID: ... Content-Type: ...`: 这 230 字节的具体内容，即客户端请求的那些邮件头。

**此步骤的目的**：
客户端（Thunderbird）获取了这些信息后，就可以在邮件列表里显示一行新的邮件条目，包含了发件人 "alice"、主题 "Work"、日期等，并且这封邮件会以**未读**状态（例如加粗）显示。

---

### 重点解释：55 号请求与响应

在用户点击了邮件列表中的这封新邮件后，客户端需要获取邮件的**全部内容**以便完整显示。

#### **请求: `55 UID fetch 2 (UID RFC822.SIZE BODY.PEEK[])`**

*   `55 UID fetch 2`: 同样，针对 UID 为 2 的邮件。
*   `( ... )`: 要获取的数据项列表。
    *   `UID`, `RFC822.SIZE`: 再次请求这些基本信息，可能是为了校验。
    *   `BODY.PEEK[]`: 这是与请求 54 的关键区别。
        *   `BODY.PEEK`: 同样，表示“偷看”，不改变 `\Seen` 标志。客户端通常会让用户自己决定何时标记为已读（比如点击其他地方后），而不是在查看时就自动标记。
        *   `[]`: 空的方括号表示“我想要整个部分”。当用在 `BODY` 上时，`BODY[]` 意味着获取**整个邮件的完整内容**，包括所有的邮件头和邮件体（body part）。

**总结请求 55 的意图**：
“你好服务器，现在请把 UID 为 2 的这封邮件的**所有内容**（从头到尾，一字不差）都发给我。同样，我只是看看，先别把它标记为已读。”

#### **响应: `* 2 FETCH (...)`**

*   `* 2 FETCH`: 同样是关于 UID 为 2 的邮件的 `FETCH` 结果。
*   `UID 2 RFC822.SIZE 621`: 重复确认基本信息。
*   `BODY[] {621}`: 服务器说：“好的，这是你请求的完整邮件，接下来的数据长度是 621 字节。”
*   `Return-Path: ... work`: 这 621 字节的原始邮件数据（raw email data），从第一个头 `Return-Path` 一直到邮件正文的最后一行 `work`。

**此步骤的目的**：
客户端（Thunderbird）获取了完整的邮件原文后，就可以在预览窗格或新窗口中将其完整地渲染出来，供用户阅读。

### 后续步骤

*   **56 号请求**: 这是一个优化。客户端可能为了更好地渲染，又单独请求了 `Content-Type` 和邮件正文（`BODY[TEXT]`）的前 2048 字节。这在处理复杂邮件（如 HTML 或带附件的邮件）时很常见。
*   **60 号请求**: `uid store 2 +Flags (\Seen)`。这通常发生在用户点击了另一封邮件，或者以其他方式表明他已经“处理”了这封邮件。客户端明确地告诉服务器：“请给 UID 为 2 的邮件**添加** `\Seen` 标志。” 服务器响应中可以看到，`FLAGS` 变成了 `(\Seen \Recent)`。至此，这封邮件在界面上会从**未读**状态变为**已读**状态。

## 邮件标签

IMAP 协议定义了以下几类系统标志（system flags），用于描述邮件的状态：

1. `\Answered`

   * 表示该邮件已经被回复过。

2. `\Flagged`

   * 表示该邮件被标记（类似星标／重要邮件）。

3. `\Deleted`

   * 表示该邮件已被用户标记为删除（实际删除需 EXPUNGE 操作）。

4. `\Seen`

   * 表示该邮件已被用户阅读过。

5. `\Draft`

   * 表示该邮件是草稿，还未真正发出。

另外，IMAP 还有一个特殊的会话标志（session-only flag）：

* `\Recent`

  * 表示自上次 SELECT/EXAMINE 以来新到达的邮件。客户端通常在进入 IDLE 或 SELECT 后关注它。

除了以上系统标志外，IMAP 也允许用户定义任意多个自定义标志（user flags），例如 `"\\ProjectX"`、`"\\Todo"` 等，服务器无需预先知道它们，客户端和服务器只要约定好即可使用。

## 删除邮件
删除邮件
```
 - user user1@tio.com <<< MDAwMDAwMDA=
 - user user1@tio.com <<< 3 capability
 - user user1@tio.com <<< 4 ID ("name" "Thunderbird" "version" "139.0.2")
 - user user1@tio.com <<< 5 select "INBOX"
 - user user1@tio.com <<< 6 UID fetch 1:* (FLAGS)
 - user user1@tio.com <<< 7 uid store 6 +Flags (\Seen)
 - user user1@tio.com <<< 9 uid move 6 "Trash"
 - user user1@tio.com <<< 10 noop
 - user user1@tio.com <<< 11 UID fetch 7:* (FLAGS)
 - user user1@tio.com <<< 12 UID fetch 6 (UID RFC822.SIZE FLAGS BODY.PEEK[HEADER.FIELDS (From To Cc Bcc Subject Date Message-ID Priority X-Priority References Newsgroups In-Reply-To Content-Type Reply-To)])
 - user user1@tio.com <<< 13 IDLE
 ```

 ## 彻底删除邮件
 ```
 user user1@tio.com <<< 86 ID ("name" "Thunderbird" "version" "139.0.2")
 user user1@tio.com <<< 87 select "Trash"
 user user1@tio.com <<< 88 UID fetch 1:* (FLAGS)
 user user1@tio.com <<< 89 uid store 1 +Flags (\Seen)
 user user1@tio.com <<< 90 IDLE
 user user1@tio.com <<< DONE
 user user1@tio.com <<< 91 authenticate LOGIN
 user user1@tio.com <<< dXNlcjFAdGlvLmNvbQ==
 user user1@tio.com <<< MDAwMDAwMDA=
 user user1@tio.com <<< 92 capability
 user user1@tio.com <<< 93 ID ("name" "Thunderbird" "version" "139.0.2")
 user user1@tio.com <<< 94 select "Trash"
 user user1@tio.com <<< 95 UID fetch 1:* (FLAGS)
 user user1@tio.com <<< 96 UID fetch 1 (UID RFC822.SIZE FLAGS BODY.PEEK[HEADER.FIELDS (From To Cc Bcc Subject Date Message-ID Priority X-Priority References Newsgroups In-Reply-To Content-Type Reply-To)])
 user user1@tio.com <<< 97 logout
```