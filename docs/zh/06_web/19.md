# è¯·æ±‚æ‹¦æˆªå™¨

[[toc]]

## æ‹¦æˆªå™¨æ¦‚è¿°

åœ¨åŸºäº Tio-Boot çš„ HTTP åº”ç”¨ä¸­ï¼Œæ‹¦æˆªå™¨ï¼ˆInterceptorï¼‰æ˜¯ä¸€ç§åœ¨è¯·æ±‚åˆ°è¾¾ä¸šåŠ¡å¤„ç†å™¨ä¹‹å‰æˆ–å“åº”è¿”å›å®¢æˆ·ç«¯ä¹‹åï¼Œå¯¹è¯·æ±‚/å“åº”è¿›è¡Œé¢„å¤„ç†å’Œåå¤„ç†çš„æœºåˆ¶ã€‚åˆç†åœ°ä½¿ç”¨æ‹¦æˆªå™¨ï¼Œå¯ç”¨äºé›†ä¸­åŒ–åœ°å¤„ç†ä»¥ä¸‹åœºæ™¯ï¼š

* **è¯·æ±‚æ ¡éªŒ**ï¼šéªŒè¯ HTTP è¯·æ±‚æ˜¯å¦åˆæ³•ï¼Œæ‹¦æˆªæ¶æ„æˆ–ç¼ºå°‘å…³é”®ä¿¡æ¯çš„è¯·æ±‚
* **é‰´æƒä¸æƒé™æ§åˆ¶**ï¼šæ£€æŸ¥è¯·æ±‚çš„è®¤è¯ä¿¡æ¯æˆ–ç”¨æˆ·æƒé™
* **æ—¥å¿—è®°å½•**ï¼šç»Ÿä¸€è®°å½•è¯·æ±‚ä¸å“åº”çš„å…ƒæ•°æ®
* **æ€§èƒ½ç›‘æ§**ï¼šç»Ÿè®¡æ–¹æ³•æ‰§è¡Œæ—¶é—´æˆ–è¯·æ±‚è€—æ—¶
* **é™æµä¸é˜²åˆ·**ï¼šå¯¹é¢‘ç¹è¯·æ±‚æˆ–å¼‚å¸¸è¯·æ±‚è¿›è¡Œé™æµæˆ–å°ç¦

---

## Interceptor & Handler Design

1. **HttpRequestValidationInterceptor** è¯·æ±‚æ ¡éªŒæ‹¦æˆªå™¨å®ç°

   * ä½œç”¨ï¼šå¯¹æ‰€æœ‰è¯·æ±‚ç”Ÿæ•ˆã€‚
   * åŠŸèƒ½ï¼šæ ¡éªŒè¯·æ±‚å¤´æ˜¯å¦åˆæ³•ï¼Œä¾‹å¦‚æ£€æŸ¥æ˜¯å¦æºå¸¦ `version` è¯·æ±‚å¤´ã€‚

2. **AuthTokenInterceptor** ç”¨æˆ·Tokenæ‹¦æˆªå™¨

   * ä½œç”¨ï¼šå¯¹æ‰€æœ‰è¯·æ±‚ç”Ÿæ•ˆã€‚
   * åŠŸèƒ½ï¼šè§£æè¯·æ±‚å¤´ä¸­çš„ `token` å‚æ•°ï¼Œæå– `userId` å¹¶å†™å…¥ `request` ä¸Šä¸‹æ–‡ã€‚

3. **UserTokenInterceptor** *(å±äº HttpRequestInterceptor)* é€šç”¨æ‹¦æˆªå™¨

   * ä½œç”¨ï¼šä»…å¯¹æŒ‡å®šé…ç½®çš„è¯·æ±‚è·¯å¾„ç”Ÿæ•ˆã€‚
   * åŠŸèƒ½ï¼šæ ¡éªŒ `userId` æ˜¯å¦å­˜åœ¨äºæ•°æ®åº“ä¸­ã€‚

4. **Handler/Controller å±‚é€»è¾‘**

   * è¯´æ˜ï¼šæŸäº› Endpoint åŒæ—¶æ”¯æŒ *å¸¦ç”¨æˆ· ID* å’Œ *ä¸å¸¦ç”¨æˆ· ID* çš„ä¸¤ç§è®¿é—®æ–¹å¼ã€‚
   * å› æ­¤åœ¨ Handler æˆ– Controller çš„ Action ä¸­ï¼Œå¯èƒ½ä»éœ€å¯¹ `userId` æ˜¯å¦å­˜åœ¨è¿›è¡Œé¢å¤–åˆ¤æ–­ã€‚

   **ç¤ºä¾‹ä»£ç **ï¼š

   ```java
   String userIdString = TioRequestContext.getUserIdString();
   if (userIdString == null) {
       httpResponse.setStatus(401);
       return httpResponse;
   }
   ```

## æ™®é€šæ‹¦æˆªå™¨

### ä¸€ã€æ¦‚è¿°

åœ¨ Tioâ€‘Boot ä¸­ï¼ŒHTTP æ‹¦æˆªå™¨ï¼ˆInterceptorï¼‰å¯ç”¨äºå¯¹è¿›å‡ºçš„è¯·æ±‚è¿›è¡Œç»Ÿä¸€æ§åˆ¶ï¼Œä¾‹å¦‚ï¼šæƒé™æ ¡éªŒã€æ—¥å¿—è®°å½•ã€é™æµç­‰ã€‚é€šè¿‡é…ç½®æ‹¦æˆªå™¨æ¨¡å‹ï¼ˆ`HttpInterceptorModel`ï¼‰ï¼Œæ‚¨å¯ä»¥çµæ´»åœ°æŒ‡å®šå“ªäº› URL åº”è¢«æ‹¦æˆªï¼ˆ`blockedUrls`ï¼‰ï¼Œå“ªäº› URL åº”è¢«æ”¾è¡Œï¼ˆ`allowedUrls`ï¼‰ï¼Œä»è€Œå®ç°ç²¾ç»†åŒ–çš„è¯·æ±‚ç®¡ç†ã€‚

---

### äºŒã€æ ¸å¿ƒç±»è¯´æ˜

#### 1. `HttpInterceptorModel`

æ‹¦æˆªå™¨çš„é…ç½®æ¨¡å‹ï¼ŒåŒ…å«ï¼š

- **åç§°** `name`ï¼šæ‹¦æˆªå™¨æ ‡è¯†ã€‚
- **æ”¾è¡Œåˆ—è¡¨** `allowedUrls`ï¼šä¸€ç»„æ˜ç¡®å…è®¸çš„ URL æ¨¡å¼ã€‚
- **æ‹¦æˆªåˆ—è¡¨** `blockedUrls`ï¼šä¸€ç»„éœ€è¦æ‹¦æˆªçš„ URL æ¨¡å¼ã€‚
- **æ‹¦æˆªå™¨å®ä¾‹** `interceptor`ï¼šå®ç° `HttpRequestInterceptor` æ¥å£çš„å¤„ç†é€»è¾‘ã€‚

å¸¸ç”¨æ–¹æ³•ï¼š

```java
// è®¾ç½®åç§°
HttpInterceptorModel model = new HttpInterceptorModel()
    .setName("exampleInterceptor");

// æ·»åŠ å•ä¸ª/å¤šä¸ªæ”¾è¡Œ URL
model.addAllowUrl("/admin/login");
model.addAllowUrls("/public/**", "/status");

// æ·»åŠ å•ä¸ª/å¤šä¸ªæ‹¦æˆª URL
model.addBlockUrl("/admin/**");
model.addAllowUrls("/api/private/**", "/secure/*");

// ç»‘å®šæ‹¦æˆªå™¨å®ç°
model.setInterceptor(new YourCustomInterceptor());
```

> **æ³¨æ„**
>
> - åŒä¸€è·¯å¾„ä¸èƒ½åŒæ—¶å‡ºç°åœ¨ `allowedUrls` å’Œ `blockedUrls` ä¸­ã€‚
> - æ”¯æŒé€šé…ç¬¦ï¼š`/**` åŒ¹é…æ‰€æœ‰å­è·¯å¾„ï¼Œ`/*` åŒ¹é…ä¸€çº§å­è·¯å¾„ã€‚

#### 2. `HttpInteceptorConfigure`

æ‹¦æˆªå™¨é…ç½®ç®¡ç†å™¨ï¼Œç”¨äºé›†ä¸­ç®¡ç†æ‰€æœ‰æ‹¦æˆªå™¨æ¨¡å‹ã€‚

```java
HttpInteceptorConfigure configure = new HttpInteceptorConfigure();
configure.add(model);      // æ·»åŠ æ‹¦æˆªå™¨
configure.remove("name");  // æŒ‰åç§°ç§»é™¤æ‹¦æˆªå™¨
List<HttpInterceptorModel> list = configure.getInteceptors(); // è·å–æ‰€æœ‰æ¨¡å‹
```

#### 3. `DefaultHttpRequestInterceptorDispatcher`

æ‰§è¡Œé“¾ä¸­çš„è°ƒåº¦å™¨ï¼Œè´Ÿè´£éå†æ‰€æœ‰ `HttpInterceptorModel`ï¼Œå¹¶åœ¨è¯·æ±‚å¤„ç†å‰åè°ƒç”¨ç›¸åº”çš„æ‹¦æˆªå™¨æ–¹æ³•ã€‚

- `doBeforeHandler`ï¼šåœ¨ä¸šåŠ¡å¤„ç†å‰æ‰§è¡Œã€‚
  - è‹¥è¿”å›é `null` çš„ `HttpResponse`ï¼Œåˆ™åç»­ä¸šåŠ¡å’Œæ‹¦æˆªå™¨é“¾å°†è¢«çŸ­è·¯ã€‚
- `doAfterHandler`ï¼šåœ¨ä¸šåŠ¡å¤„ç†åæ‰§è¡Œã€‚

---

### ä¸‰ã€åœ¨ TioBootServer ä¸­æ³¨å†Œæ‹¦æˆªå™¨

åœ¨å¯åŠ¨ç±»æˆ–é…ç½®ç±»ä¸­ï¼Œé€šè¿‡ `TioBootServer` å°†è‡ªå®šä¹‰çš„æ‹¦æˆªå™¨é…ç½®æ³¨å…¥åˆ°æœåŠ¡å™¨ï¼š

```java
import com.litongjava.annotation.AConfiguration;
import com.litongjava.annotation.Initialization;
import com.litongjava.tio.boot.http.interceptor.HttpInteceptorConfigure;
import com.litongjava.tio.boot.http.interceptor.HttpInterceptorModel;
import com.litongjava.tio.boot.server.TioBootServer;

@AConfiguration
public class InterceptorConfiguration {

  @Initialization
  public void init() {
    // 1. æ„å»ºä¸€ä¸ªå…¨å±€æ‹¦æˆªå™¨æ¨¡å‹
    HttpInterceptorModel global = new HttpInterceptorModel()
        .setName("globalInterceptor")
        .addBlockUrl("/**")         // æ‹¦æˆªæ‰€æœ‰è·¯å¾„
        .addAllowedUrl("/health")     // æ”¾è¡Œå¥åº·æ£€æŸ¥æ¥å£
        .setInterceptor(new GlobalInterceptor());

    // 2. åˆ›å»ºé…ç½®ç®¡ç†å™¨å¹¶æ·»åŠ æ¨¡å‹
    HttpInteceptorConfigure config = new HttpInteceptorConfigure();
    config.addInterceptor(global);

    // 3. æ³¨å…¥åˆ° TioBootServer
    TioBootServer.me().setHttpInteceptorConfigure(config);
  }
}
```

---

### å››ã€è‡ªå®šä¹‰æ‹¦æˆªå™¨ç¤ºä¾‹

è‡ªå®šä¹‰æ‹¦æˆªå™¨éœ€å®ç° `HttpRequestInterceptor` æ¥å£ï¼Œç¤ºä¾‹ä¸­å°†è¯·æ±‚æ—¥å¿—æ‰“å°åˆ°æ§åˆ¶å°ï¼š

```java
package com.litongjava.demo.interceptor;

import com.litongjava.tio.http.common.HttpRequest;
import com.litongjava.tio.http.common.HttpResponse;
import com.litongjava.tio.http.common.RequestLine;
import com.litongjava.tio.http.server.intf.HttpRequestInterceptor;
import lombok.extern.slf4j.Slf4j;

@Slf4j
public class GlobalInterceptor implements HttpRequestInterceptor {

  @Override
  public HttpResponse doBeforeHandler(
      HttpRequest request,
      RequestLine requestLine,
      HttpResponse originalResponse) throws Exception
  {
    log.info("[Before] {} {}", requestLine.getMethod(), requestLine.getPath());
    // è¿”å› null è¡¨ç¤ºç»§ç»­æ‰§è¡Œåç»­æ‹¦æˆªå™¨å’Œä¸šåŠ¡å¤„ç†
    return null;
  }

  @Override
  public void doAfterHandler(
      HttpRequest request,
      RequestLine requestLine,
      HttpResponse response,
      long costMillis) throws Exception
  {
    log.info("[After] {} {} -> {} ({} ms)",
             requestLine.getMethod(),
             requestLine.getPath(),
             response.getStatus(),
             costMillis);
  }
}
```

---

### äº”ã€URL åŒ¹é…ä¸æ‰§è¡Œé€»è¾‘

1. **åŒ¹é…é¡ºåº**  
   `DefaultHttpRequestInterceptorDispatcher` ä¼šä¾æ¬¡éå†æ‰€æœ‰å·²æ³¨å†Œçš„ `HttpInterceptorModel`ã€‚

2. **æ‹¦æˆªåˆ¤å®š**

   - è‹¥è¯·æ±‚ URL ä¸æŸä¸ªæ¨¡å‹çš„ `blockedUrls` ä»»ä¸€æ¨¡å¼åŒ¹é…ï¼Œä¸”ä¸åœ¨è¯¥æ¨¡å‹çš„ `allowedUrls` ä¸­ï¼Œåˆ™è§†ä¸ºéœ€æ‹¦æˆªã€‚
   - åœ¨ `doBeforeHandler` ä¸­è‹¥è¿”å›éç©º `HttpResponse`ï¼Œåˆ™ç›´æ¥è¿”å›è¯¥å“åº”ï¼Œä¸å†æ‰§è¡Œåç»­æ‹¦æˆªå™¨ä¸ä¸šåŠ¡é€»è¾‘ã€‚è¿™ä¸€ç‚¹å¾ˆé‡è¦,å’Œå…¶å®ƒwebæ¡†æ¶ä¸åŒ,å¦‚æœæƒ³è¦åç»­çš„æ‹¦æˆªå™¨å’Œä¸šåŠ¡é€»è¾‘æ‰§è¡Œ,åŠ¡å¿…è¿”å›null

3. **é€šé…ç¬¦è§„åˆ™**
   - `/api/**`ï¼šåŒ¹é… `/api` åŠå…¶æ‰€æœ‰å­è·¯å¾„ã€‚
   - `/static/*`ï¼šä»…åŒ¹é…ä¸€çº§å­è·¯å¾„ï¼Œå¦‚ `/static/logo.png`ã€‚

---

### å…­ã€æœ€ä½³å®è·µ

- **åˆ†å±‚æ³¨å†Œ**ï¼šå¯æ ¹æ®ä¸šåŠ¡æ¨¡å—ï¼Œå°†æ‹¦æˆªå™¨æŒ‰èŒè´£æ‹†åˆ†æˆå¤šä¸ªæ¨¡å‹ï¼Œå¦‚è®¤è¯ã€æˆæƒã€æ—¥å¿—ã€é™æµç­‰ï¼ŒæŒ‰éœ€ç»„åˆã€‚
- **ç²¾ç¡®æ”¾è¡Œ**ï¼šå°½é‡å°† `allowedUrls` é…ç½®å¾—æ›´ç²¾ç»†ï¼Œä¾‹å¦‚æ”¾è¡Œé™æ€èµ„æºã€å¥åº·æ£€æŸ¥ã€ç™»å½•å›è°ƒç­‰ã€‚
- **æ€§èƒ½è€ƒé‡**ï¼šæ‹¦æˆªå™¨é“¾ä¸­çš„æ‰§è¡Œé€»è¾‘åº”å°½é‡è½»é‡ï¼Œé¿å…é˜»å¡æˆ–è€—æ—¶æ“ä½œï¼›å¦‚éœ€å¤æ‚å¤„ç†ï¼Œå¯å¼‚æ­¥æ‰§è¡Œæˆ–äº¤ç”±ä¸“ç”¨æœåŠ¡ã€‚
- **å•å…ƒæµ‹è¯•**ï¼šå¯¹è‡ªå®šä¹‰æ‹¦æˆªå™¨é€»è¾‘ç¼–å†™å•å…ƒæµ‹è¯•ï¼ŒéªŒè¯ä¸åŒ URL ä¸‹çš„æ‹¦æˆªä¸æ”¾è¡Œè¡Œä¸ºã€‚

---

### ä¸ƒã€æ€»ç»“

é€šè¿‡ä»¥ä¸Šé…ç½®ï¼Œæ‚¨å¯ä»¥åœ¨ Tioâ€‘Boot åº”ç”¨ä¸­è½»æ¾åœ°ç®¡ç† HTTP è¯·æ±‚çš„æ‹¦æˆªä¸æ”¾è¡Œï¼Œå®ç°ç»Ÿä¸€çš„å®‰å…¨ã€é™æµã€ç›‘æ§ç­‰åŠŸèƒ½ã€‚æ‹¦æˆªå™¨æ¨¡å‹ä¸è°ƒåº¦å™¨è§£è€¦ï¼Œé…ç½®çµæ´»ä¸”å¯æ‰©å±•ã€‚å®è·µä¸­å¯ç»“åˆä¸šåŠ¡éœ€æ±‚ï¼Œå®šåˆ¶å¤šå±‚æ‹¦æˆªç­–ç•¥ï¼Œè¿›ä¸€æ­¥æå‡ç³»ç»Ÿçš„å¥å£®æ€§ä¸å¯ç»´æŠ¤æ€§ã€‚

## è¯·æ±‚æ ¡éªŒæ‹¦æˆªå™¨å®ç°

æœ¬ç« å°†é‡ç‚¹ä»‹ç»å¦‚ä½•åœ¨ Tio-Boot ä¸­ç¼–å†™å’Œé…ç½®â€œè¯·æ±‚æ ¡éªŒæ‹¦æˆªå™¨â€ï¼ˆ`HttpRequestValidationInterceptor`ï¼‰ï¼Œå®ç°å¯¹ç¼ºå¤±å¿…å¡« Header çš„æ‹¦æˆªã€å°ç¦é«˜é¢‘â€œæ— å¤´â€è¯·æ±‚çš„åŠŸèƒ½ï¼Œå¹¶æ¼”ç¤ºå¦‚ä½•åœ¨å¯åŠ¨é…ç½®ç±»ä¸­æ³¨å†Œè¯¥æ‹¦æˆªå™¨ã€‚

### 1. è®¾è®¡æ€è·¯

1. **æ— å¤´è¯·æ±‚åˆ¤å®š**ï¼šå½“è¯·æ±‚ç¼ºå°‘å…³é”® Headerï¼ˆä¾‹å¦‚ `from`ï¼‰æ—¶ï¼Œè®¤ä¸ºè¯¥è¯·æ±‚ä¸åˆæ³•ã€‚
2. **è®¡æ•°ä¸é˜ˆå€¼**ï¼šç»Ÿè®¡åŒä¸€ IP çš„â€œæ— å¤´è¯·æ±‚â€æ¬¡æ•°ï¼Œè¶…è¿‡è®¾å®šé˜ˆå€¼ï¼ˆå¦‚ 10 æ¬¡ï¼‰åï¼Œå°†è¯¥ IP åŠ å…¥é»‘åå•ï¼ˆå¯æ‰©å±•ä¸ºæŒä¹…åŒ–åˆ° Redis æˆ–é˜²ç«å¢™è§„åˆ™ï¼‰ã€‚
3. **è¿”å›å“åº”**ï¼šå¯¹äºæ¯ä¸€æ¬¡æ— å¤´è¯·æ±‚ï¼Œéƒ½è¿”å› HTTP 403 å¹¶ä¸»åŠ¨å…³é—­è¿æ¥ã€‚

### 2. è‡ªå®šä¹‰æ‹¦æˆªæ‹¦æˆªå™¨æ ¡éªŒé€»è¾‘

```java
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ConcurrentMap;
import java.util.concurrent.atomic.AtomicInteger;

import com.litongjava.tio.http.common.HttpRequest;
import com.litongjava.tio.http.common.HttpResponse;
import com.litongjava.tio.http.common.RequestLine;
import com.litongjava.tio.http.server.intf.HttpRequestInterceptor;

/**
 * åº”ç”¨çº§è¯·æ±‚æ ¡éªŒæ‹¦æˆªå™¨
 * 1. æ£€æŸ¥è¯·æ±‚æ˜¯å¦åŒ…å«å¿…è¦ Header
 * 2. ç´¯è®¡æ— å¤´è¯·æ±‚æ¬¡æ•°ï¼Œè¶…è¿‡é˜ˆå€¼åˆ™å°ç¦ IP
 */
public class AppRequestValidationInterceptor implements HttpRequestInterceptor {

  // å­˜å‚¨æ¯ä¸ª IP çš„æ— å¤´è¯·æ±‚è®¡æ•°
  private final ConcurrentMap<String, AtomicInteger> badCount = new ConcurrentHashMap<>();
  private static final int MAX_BAD = 10;

  @Override
  public HttpResponse doBeforeHandler(HttpRequest request, RequestLine requestLine, HttpResponse httpResponse) throws Exception {
    String from = request.getHeader("from");
    String clientIp = request.channelContext.getClientNode().getIp();

    // å¦‚æœç¼ºå°‘ from Headerï¼Œåˆ™è§†ä¸ºæ— å¤´è¯·æ±‚
    if (from == null) {
      // ç´¯åŠ è®¡æ•°
      int count = badCount.computeIfAbsent(clientIp, k -> new AtomicInteger()).incrementAndGet();

      // è¿”å› 403ï¼Œä¸»åŠ¨å…³é—­è¿æ¥
      httpResponse.setStatus(403);
      httpResponse.setHeader("Connection", "close");
      httpResponse.setKeepConnection(false);

      // è¶…è¿‡é˜ˆå€¼ï¼Œæ‰§è¡Œå°ç¦é€»è¾‘
      if (count >= MAX_BAD) {
        blockIp(clientIp);
      }
      return httpResponse;
    } else {
      //å¿…é¡»è¿”å›null,è®©è¯·æ±‚ç»§ç»­å‘åæ‰§è¡Œ
      return null;
    }

  }

  /**
   * å°ç¦ IPï¼ˆå¯æ ¹æ®å®é™…éœ€æ±‚æ‰©å±•ä¸ºï¼šåŠ å…¥ Redisã€æ›´æ–°é˜²ç«å¢™è§„åˆ™ç­‰ï¼‰
   */
  private void blockIp(String ip) {
    // TODO: å°† IP æŒä¹…åŒ–åˆ°é»‘åå•ï¼Œæ¯”å¦‚ Redis æˆ–é˜²ç«å¢™è§„åˆ™
  }

  @Override
  public void doAfterHandler(HttpRequest request, RequestLine requestLine, HttpResponse response, long cost) {
    // åç½®å¤„ç†ï¼šç›®å‰æ— æ“ä½œ
  }
}
```

---

### 3. åœ¨ Tio-Boot ä¸­é…ç½®ä¸ä½¿ç”¨

ä¸ºäº†ä½¿ä¸Šè¿°æ‹¦æˆªå™¨ç”Ÿæ•ˆï¼Œéœ€è¦åœ¨åº”ç”¨å¯åŠ¨é…ç½®ç±»ä¸­æ³¨å†Œå®ƒã€‚Tio-Boot æä¾›äº†é€šè¿‡æ³¨è§£å’Œåˆå§‹åŒ–æ–¹æ³•æ¥å®Œæˆè¿™ä¸€æ“ä½œçš„èƒ½åŠ›ã€‚

```java
import com.litongjava.annotation.AConfiguration;
import com.litongjava.annotation.Initialization;
import com.litongjava.tio.boot.server.TioBootServer;
@AConfiguration
public class InterceptorConfiguration {

  /**
   * åº”ç”¨åˆå§‹åŒ–æ—¶æ³¨å†Œè¯·æ±‚æ ¡éªŒæ‹¦æˆªå™¨
   */
  @Initialization
  public void config() {
    // è·å– Tio-Boot æœåŠ¡å™¨å•ä¾‹
    TioBootServer server = TioBootServer.me();

    // åˆ›å»ºå¹¶æ³¨å†Œè‡ªå®šä¹‰æ‹¦æˆªå™¨
    AppRequestValidationInterceptor validationInterceptor = new AppRequestValidationInterceptor();
    server.setHttpRequestValidationInterceptor(validationInterceptor);
  }
}
```

> **è¯´æ˜**ï¼š
>
> * `@AConfiguration` æ ‡è®°è¯¥ç±»ä¸ºé…ç½®ç±»ï¼Œéœ€è¢«æ¡†æ¶æ‰«æã€‚
> * `@Initialization` æ ‡è®°çš„æ–¹æ³•åœ¨åº”ç”¨å¯åŠ¨æ—¶è¢«è°ƒç”¨ã€‚
> * `TioBootServer.me()` è¿”å› TioBootServer å•ä¾‹ï¼Œ`setHttpRequestValidationInterceptor(...)` ç”¨äºæ›¿æ¢é»˜è®¤çš„è¯·æ±‚æ ¡éªŒæ‹¦æˆªå™¨ã€‚

---

### 4.æ‹“å±•ä¸ä¼˜åŒ–

1. **é»‘åå•æŒä¹…åŒ–**

   * å°†è¢«å°ç¦çš„ IP å†™å…¥ Redisã€æ•°æ®åº“æˆ–é˜²ç«å¢™è§„åˆ™ï¼Œé‡å¯åä¾ç„¶ç”Ÿæ•ˆï¼›
   * å®šæœŸæ¸…ç†è¿‡æœŸæˆ–ä¸´æ—¶å°ç¦ IPã€‚

2. **åŠ¨æ€é˜ˆå€¼ä¸å‘Šè­¦**

   * æ ¹æ®åº”ç”¨è¿è¡Œæ—¶è´Ÿè½½æˆ–å®‰å…¨ç­–ç•¥åŠ¨æ€è°ƒæ•´ `MAX_BAD`ï¼›
   * å½“æŸä¸ª IP æ¬¡æ•°æ¿€å¢æ—¶ï¼Œå¯è§¦å‘å‘Šè­¦é€šçŸ¥è¿ç»´äººå‘˜ã€‚

3. **ç™½åå•æœºåˆ¶**

   * å¯¹æŸäº›å—ä¿¡ä»»çš„ IP æ®µæˆ–å†…ç½‘åœ°å€è·³è¿‡æ ¡éªŒã€‚

4. **å¤šç»´åº¦å®‰å…¨æ ¡éªŒ**

   * é™¤äº† Header æ ¡éªŒï¼Œè¿˜å¯ç»“åˆç­¾åæ ¡éªŒã€ä»¤ç‰Œæ ¡éªŒæˆ–éªŒè¯ç ç­‰æ‰‹æ®µï¼›
   * å¯¹è¯·æ±‚é¢‘ç‡ã€è¯·æ±‚ä½“å¤§å°ã€URL è·¯å¾„ç­‰è¿›è¡Œé™æµæˆ–è¿‡æ»¤ã€‚

---

### 5.å°ç»“

æœ¬æ–‡ä»‹ç»äº†å¦‚ä½•åœ¨ Tio-Boot æ¡†æ¶ä¸­ç¼–å†™ä¸€ä¸ªâ€œè¯·æ±‚æ ¡éªŒæ‹¦æˆªå™¨â€ï¼Œè¯¥æ‹¦æˆªå™¨èƒ½å¤Ÿåœ¨è¯·æ±‚åˆ°è¾¾ä¸šåŠ¡å¤„ç†å™¨å‰ï¼ŒéªŒè¯è¯·æ±‚æ˜¯å¦åˆæ³•ã€ç»Ÿè®¡æ— å¤´è¯·æ±‚å¹¶åœ¨è¶…è¿‡é˜ˆå€¼åå°ç¦ IPã€‚é€šè¿‡æ³¨è§£å¼é…ç½®ï¼Œå¯è½»æ¾å°†è¯¥æ‹¦æˆªå™¨é›†æˆåˆ°é¡¹ç›®ä¸­ã€‚å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¯æ ¹æ®ä¸šåŠ¡éœ€æ±‚è¿›ä¸€æ­¥æ‰©å±•æŒä¹…åŒ–ã€å‘Šè­¦åŠç™½åå•ç­‰åŠŸèƒ½ï¼Œä»¥æå‡åº”ç”¨çš„å®‰å…¨é˜²æŠ¤èƒ½åŠ›ã€‚

å¥½çš„ ğŸ‘ æˆ‘å¸®ä½ æŠŠè¿™éƒ¨åˆ†æ•´ç†æ¶¦è‰²æˆä¸€ä»½**å®Œæ•´çš„æ–‡æ¡£**ï¼ŒåŠ ä¸ŠèƒŒæ™¯ã€ç”¨é€”å’Œç›®æ ‡è¯´æ˜ï¼Œè®©å®ƒæ›´åƒä¸€ç¯‡å¯ä»¥ç›´æ¥æ”¾åœ¨å¼€å‘æ–‡æ¡£é‡Œçš„æŠ€æœ¯è¯´æ˜ã€‚

---

## ä½¿ç”¨ AuthTokenInterceptor å’Œ UserTokenInterceptor çš„å®è·µæŒ‡å—

### èƒŒæ™¯

åœ¨åŸºäº **Tio-Boot** æ¡†æ¶çš„ Web åº”ç”¨ä¸­ï¼Œæ¥å£å®‰å…¨å’Œç”¨æˆ·èº«ä»½ç®¡ç†æ˜¯åç«¯ç³»ç»Ÿè®¾è®¡çš„æ ¸å¿ƒé—®é¢˜ã€‚
å¸¸è§éœ€æ±‚åŒ…æ‹¬ï¼š

1. **è¯·æ±‚å¤´æ ¡éªŒ**ï¼šç¡®ä¿è¯·æ±‚å¤´ä¸­åŒ…å«å¿…è¦å‚æ•°ï¼ˆå¦‚ `version`ï¼‰ã€‚
2. **èº«ä»½è®¤è¯**ï¼šé€šè¿‡è¯·æ±‚å¤´ä¸­çš„ `token` æ ¡éªŒç”¨æˆ·æ˜¯å¦åˆæ³•ã€‚
3. **ç”¨æˆ·ä¸Šä¸‹æ–‡ç®¡ç†**ï¼šåœ¨è¯·æ±‚çš„ç”Ÿå‘½å‘¨æœŸä¸­å®‰å…¨ã€ç»Ÿä¸€åœ°ä¼ é€’ç”¨æˆ· IDã€‚
4. **æƒé™éš”ç¦»**ï¼šæ”¯æŒéƒ¨åˆ†æ¥å£æ— éœ€ç™»å½•å³å¯è®¿é—®ï¼Œå…¶ä»–æ¥å£åˆ™éœ€è¦åˆæ³•ç”¨æˆ·èº«ä»½ã€‚

ä¸ºæ­¤ï¼ŒTio-Boot æä¾›äº† **AuthTokenInterceptor** å’Œ **UserTokenInterceptor** ä¸¤ä¸ªå†…ç½®æ‹¦æˆªå™¨ï¼Œå®ƒä»¬é…åˆä½¿ç”¨å¯ä»¥æ»¡è¶³ä¸Šè¿°éœ€æ±‚ã€‚

---

### ç›®æ ‡

* **ç»Ÿä¸€ Token éªŒè¯é€»è¾‘**ï¼šæ”¯æŒç³»ç»Ÿç®¡ç†å‘˜ Token å’Œæ™®é€šç”¨æˆ· Token çš„éªŒè¯ã€‚
* **é€æ˜çš„ç”¨æˆ·ä¸Šä¸‹æ–‡ä¼ é€’**ï¼šé€šè¿‡æ‹¦æˆªå™¨å°† `userId` æ³¨å…¥åˆ° `TioRequestContext`ï¼Œåœ¨ Controller ä¸­ç›´æ¥è·å–ã€‚
* **å¯é…ç½®åŒ–**ï¼šå…è®¸å®šä¹‰æ— éœ€æ‹¦æˆªçš„ URLï¼ˆå¦‚ç™»å½•ã€æ³¨å†Œã€éªŒè¯ç æ¥å£ï¼‰ï¼ŒåŒæ—¶çµæ´»æ‰©å±• Token éªŒè¯é€»è¾‘ã€‚
* **å®‰å…¨æ€§**ï¼šå¯¹éæ³•è¯·æ±‚ï¼ˆæ—  Token æˆ– Token æ ¡éªŒå¤±è´¥ï¼‰ç»Ÿä¸€æ‹¦æˆªï¼Œè¿”å› `401 Unauthorized`ã€‚

---

### æ‹¦æˆªå™¨èŒè´£åˆ†å·¥

1. **AuthTokenInterceptor**

   * è´Ÿè´£ **éªŒè¯ Token åˆæ³•æ€§**ã€‚
   * æ”¯æŒä¸¤ç±» Tokenï¼š

     * **ç³»ç»Ÿç®¡ç†å‘˜ Token**ï¼šä»ç¯å¢ƒå˜é‡è·å–å¹¶æ¯”å¯¹ã€‚
     * **ç”¨æˆ· JWT Token**ï¼šé€šè¿‡ `JwtUtils` éªŒè¯ç­¾åä¸æœ‰æ•ˆæœŸï¼Œå¹¶è§£æ `userId`ã€‚
   * éªŒè¯é€šè¿‡åï¼Œå°†ç”¨æˆ· ID å†™å…¥ `TioRequestContext`ã€‚

2. **UserTokenInterceptor**

   * è´Ÿè´£ **æ‹¦æˆªè¯·æ±‚å¹¶è¿›è¡Œç”¨æˆ·æ ¡éªŒ**ã€‚
   * é»˜è®¤æ‹¦æˆªæ‰€æœ‰ URL (`/**`)ï¼Œä½†æ”¯æŒé…ç½® **ç™½åå• URL**ï¼Œå¦‚ç™»å½•ã€æ³¨å†Œã€éªŒè¯ç ã€é™æ€èµ„æºç­‰æ¥å£ã€‚
   * å¦‚æœè¯·æ±‚æœªæºå¸¦æœ‰æ•ˆ Tokenï¼Œåˆ™é˜»æ­¢è¯·æ±‚ç»§ç»­ä¸‹å‘ã€‚

---

### æœ€ä½³å®è·µå®ä¾‹

#### 1. å®šä¹‰ç™½åå• URL

```java
public interface TioBootAdminUrls {
  String[] ALLLOW_URLS = {
    "", "/",
    "/api/event/add",
    "/register/*", "/api/login/account", "/api/login/outLogin",
    "/api/v1/login", "/api/v1/register", "/api/v1/user/referesh",
    "/api/v1/sendVerification", "/api/v1/sendVerificationCode", "/api/v1/verify",
    "/verification/email", "/api/v1/user/resetPassword", "/api/v1/anonymous/create",
    "/api/v1/google/login", "/api/v1/user/refresh",
    "/table/json/tio_boot_admin_system_article/get/*",
    "/table/json/tio_boot_admin_system_docx/get/*",
    "/table/json/tio_boot_admin_system_pdf/get/*"
  };
}
```

#### 2. è‡ªå®šä¹‰ Token éªŒè¯é€»è¾‘

```java
package com.litongjava.tio.boot.admin.services;

import java.util.function.Predicate;

import com.litongjava.tio.boot.admin.costants.AppConstant;
import com.litongjava.tio.boot.http.TioRequestContext;
import com.litongjava.tio.utils.environment.EnvUtils;
import com.litongjava.tio.utils.jwt.JwtUtils;

public class TioBootAdminTokenPredicate implements Predicate<String> {

  @Override
  public boolean test(String token) {
    String adminToken = EnvUtils.get(AppConstant.ADMIN_TOKEN);
    //system token
    if (adminToken != null && adminToken.equals(token)) {
      TioRequestContext.setUserId(0L);
      return true;
    }

    // user and admin token
    String key = EnvUtils.getStr(AppConstant.ADMIN_SECRET_KEY);
    boolean verify = JwtUtils.verify(key, token);
    if (verify) {
      String userId = JwtUtils.parseUserIdString(token);
      TioRequestContext.setUserId(userId);
      return true;
    }
    return false;
  }

  public Long parseUserIdLong(String token) {
    String key = EnvUtils.getStr(AppConstant.ADMIN_SECRET_KEY);
    boolean verify = JwtUtils.verify(key, token);
    if (verify) {
      return JwtUtils.parseUserIdLong(token);
    }
    return null;
  }
}
```

#### 3. é…ç½®æ‹¦æˆªå™¨

```java
package com.litongjava.tio.boot.admin.config;

import java.util.function.Predicate;

import com.litongjava.tio.boot.admin.costants.TioBootAdminUrls;
import com.litongjava.tio.boot.admin.services.TioBootAdminTokenPredicate;
import com.litongjava.tio.boot.http.interceptor.HttpInteceptorConfigure;
import com.litongjava.tio.boot.http.interceptor.HttpInterceptorModel;
import com.litongjava.tio.boot.server.TioBootServer;
import com.litongjava.tio.boot.token.AuthTokenInterceptor;
import com.litongjava.tio.boot.token.UserTokenInterceptor;

public class TioAdminInterceptorConfiguration {

  private String[] permitUrls;
  private boolean alloweStaticFile;
  private Predicate<String> validateTokenLogic;

  public TioAdminInterceptorConfiguration() {
  }

  public TioAdminInterceptorConfiguration(String[] permitUrls) {
    this.permitUrls = permitUrls;
  }

  public TioAdminInterceptorConfiguration(String[] permitUrls, Predicate<String> validateTokenLogic) {
    this.permitUrls = permitUrls;
    this.validateTokenLogic = validateTokenLogic;
  }

  public TioAdminInterceptorConfiguration(String[] permitUrls, boolean b) {
    this.permitUrls = permitUrls;
    this.alloweStaticFile = b;
  }

  public void config() {
    // tokenéªŒè¯é€»è¾‘
    if (validateTokenLogic == null) {
      validateTokenLogic = new TioBootAdminTokenPredicate();
    }

    AuthTokenInterceptor authTokenInterceptor = new AuthTokenInterceptor(validateTokenLogic);
    TioBootServer.me().setAuthTokenInterceptor(authTokenInterceptor);

    UserTokenInterceptor userTokenInterceptor = new UserTokenInterceptor();
    HttpInterceptorModel model = new HttpInterceptorModel();
    model.setInterceptor(userTokenInterceptor);
    // æ‹¦æˆªæ‰€æœ‰è·¯ç”±
    model.addBlockUrl("/**");

    // æ·»åŠ ä¸æ‹¦æˆªçš„è·¯ç”±
    model.addAllowUrls(TioBootAdminUrls.ALLLOW_URLS);

    if (permitUrls != null) {
      model.addAllowUrls(permitUrls);
    }
    model.setAlloweStaticFile(alloweStaticFile);

    HttpInteceptorConfigure inteceptorConfigure = new HttpInteceptorConfigure();
    inteceptorConfigure.add(model);
    // å°†æ‹¦æˆªå™¨é…ç½®æ·»åŠ åˆ° Tio æœåŠ¡å™¨
    TioBootServer.me().setHttpInteceptorConfigure(inteceptorConfigure);
  }
}

```

---

### Controller å±‚çš„ä½¿ç”¨

åœ¨ Controller æˆ– Handler ä¸­ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡ `TioRequestContext` è·å–ç”¨æˆ· IDï¼š

```java
String userIdString = TioRequestContext.getUserIdString();
if (userIdString == null) {
    httpResponse.setStatus(401);
    return httpResponse;
}
// æ ¹æ® userId æ‰§è¡Œä¸šåŠ¡é€»è¾‘
```

âš ï¸ æ³¨æ„ï¼šéƒ¨åˆ†æ¥å£æ—¢å…è®¸åŒ¿åè®¿é—®ï¼Œä¹Ÿå…è®¸å¸¦ç”¨æˆ· ID çš„è®¿é—®ï¼Œéœ€è¦å¼€å‘è€…åœ¨ Controller ä¸­åšè¿›ä¸€æ­¥çš„åˆ¤æ–­ã€‚

---

### æ€»ç»“

é€šè¿‡ **AuthTokenInterceptor** ä¸ **UserTokenInterceptor** çš„é…åˆä½¿ç”¨ï¼ŒTio-Boot æä¾›äº†ä¸€å¥—çµæ´»ã€å®‰å…¨çš„ **Token éªŒè¯ä¸ç”¨æˆ·ä¸Šä¸‹æ–‡ç®¡ç†æœºåˆ¶**ï¼Œå…¶ä¼˜åŠ¿åŒ…æ‹¬ï¼š

* æ”¯æŒç®¡ç†å‘˜å’Œæ™®é€šç”¨æˆ·çš„åŒé‡ Token éªŒè¯ã€‚
* è¯·æ±‚æ‹¦æˆªä¸ Token éªŒè¯è§£è€¦ï¼ŒèŒè´£æ¸…æ™°ã€‚
* å¯é…ç½®ç™½åå• URLï¼Œæ»¡è¶³å¼€æ”¾æ¥å£éœ€æ±‚ã€‚
* åœ¨ Controller ä¸­ä½¿ç”¨ç®€å•ï¼Œæå‡å¼€å‘æ•ˆç‡ã€‚

è¿™å¥—æœºåˆ¶æ—¢èƒ½ä¿è¯ç³»ç»Ÿçš„å®‰å…¨æ€§ï¼Œåˆä¸ºå¼€å‘è€…æä¾›äº†çµæ´»çš„é…ç½®å’Œæ‰©å±•èƒ½åŠ›ã€‚

---
