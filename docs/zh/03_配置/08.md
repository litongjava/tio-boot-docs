# 开启虚拟线程（Virtual Thread）

[[toc]]

## 一、背景说明

自 **Java 21** 起，**虚拟线程（Virtual Thread）** 正式成为稳定特性（JEP 444），为高并发场景提供了一种低成本、高吞吐的线程模型。
虚拟线程由 JVM 调度，不再一一映射到操作系统线程，能够显著降低线程创建和上下文切换的开销。

`t-io` 作为高性能网络框架，在 Java 21 环境下，可以通过自定义 `ThreadFactory` 的方式，**让业务处理线程运行在虚拟线程之上**，从而提升并发能力和资源利用率。

---

## 二、Java 版本要求

> **必须使用 Java 21 或以上版本**

原因如下：

* Java 19 / 20 中虚拟线程仍为预览特性
* Java 21 开始，虚拟线程正式 GA
* `Thread.ofVirtual()` API 在 Java 21 中稳定可用

建议启动参数确认版本：

```bash
java -version
```

---

## 三、示例代码说明

下面是一个在 `tio-boot` 中启用虚拟线程的最小示例。

```java
package com.litongjava.tio.boot.benchmarker;

import java.lang.Thread.Builder.OfVirtual;
import java.util.concurrent.ThreadFactory;

import com.litongjava.tio.boot.TioApplication;
import com.litongjava.tio.boot.benchmarker.config.BenchMarkerAppCconfig;
import com.litongjava.tio.boot.server.TioBootServer;

public class BenchMarkerApp {
  public static void main(String[] args) {

    long start = System.currentTimeMillis();

    // 1. 创建虚拟线程 Builder
    OfVirtual ofVirtual = Thread.ofVirtual();

    // 2. 创建虚拟线程工厂，并指定线程名称前缀
    ThreadFactory factory = ofVirtual.name("tio-v-", 1).factory();

    // 3. 获取 TioBootServer 实例并设置线程工厂
    TioBootServer server = TioBootServer.me();
    server.setThreadFactory(factory);

    // 4. 启动 tio-boot 应用
    TioApplication.run(BenchMarkerApp.class,new BenchMarkerAppCconfig(),args);

    long end = System.currentTimeMillis();
    System.out.println((end - start) + "ms");
  }
}
```

---


## 四、重要说明（非常关键）

### 1. tio-boot 并非所有线程都是虚拟线程

**需要特别注意：**

> **tio-boot 内部在处理“就绪事件（Ready / SelectionKey）”时所使用的线程，并不是虚拟线程。**

具体来说：

* **IO 事件监听线程（Selector / Reactor）**

  * 仍然是 **平台线程**
  * 数量有限
  * 对 CPU 绑定较强

* **业务处理线程**

  * 通过 `setThreadFactory` 创建
  * 可以是 **虚拟线程**
  * 数量可以非常大

这是一个**典型的 Reactor + Worker 架构**设计，也是目前虚拟线程在网络框架中的最佳实践方式。

---

### 2. 为什么不把 IO 线程改成虚拟线程？

原因包括：

* Selector 依赖阻塞/非阻塞 IO 语义
* 虚拟线程更适合：

  * 阻塞式业务逻辑
  * 数据库访问
  * RPC 调用
  * 文件 IO
* Reactor 线程数量通常很少，本身不是性能瓶颈

---

## 六、适用场景分析

启用虚拟线程后，tio-boot 非常适合以下场景：

* 高并发长连接（WebSocket、TCP）
* 大量阻塞型业务逻辑

  * JDBC
  * Redis
  * HTTP 调用
* Benchmark / 压测场景
* 服务端需要承载大量并发请求但单请求逻辑不复杂

---

## 七、总结

* Java 21 起，虚拟线程可以安全用于生产环境
* tio-boot 支持通过 `ThreadFactory` 注入虚拟线程
* **业务处理线程可使用虚拟线程**
* **IO 就绪事件处理线程仍然是平台线程**
* 这种混合模型兼顾了性能、稳定性与可扩展性

---