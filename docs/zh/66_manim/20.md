# Modal å¹³å° GPU ç¯å¢ƒä¸‹è¿è¡Œ Manim

åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†æ¼”ç¤ºå¦‚ä½•é…ç½®ä¸€ä¸ª Modal åº”ç”¨ï¼Œä½¿å…¶åœ¨å¸¦ GPUï¼ˆä¾‹å¦‚ A10Gï¼‰çš„å®¹å™¨ä¸­è¿è¡Œ Manim è„šæœ¬è¿›è¡Œæ¸²æŸ“ã€‚æ•´ä¸ªè¿‡ç¨‹åŒ…å«ä»¥ä¸‹å…³é”®æ­¥éª¤ï¼š

- **é€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒ**ï¼šä½¿ç”¨ NVIDIA æä¾›çš„ CUDA å¼€å‘é•œåƒï¼ˆå¦‚ `nvidia/cuda:12.2.0-devel-ubuntu22.04`ï¼‰ï¼Œç¡®ä¿å®¹å™¨ä¸­å…·å¤‡å¿…è¦çš„ CUDA åº“ï¼ŒåŒæ—¶æ·»åŠ  Python 3.10 ç¯å¢ƒã€‚
- **å®‰è£…ç³»ç»Ÿä¾èµ–**ï¼šç”±äº Manim çš„æ–‡æœ¬æ¸²æŸ“ç»„ä»¶ **ManimPango** éœ€è¦ä»æºç æ„å»ºï¼ˆLinux ä¸‹æ— é¢„ç¼–è¯‘ wheelï¼‰ï¼Œå› æ­¤éœ€è¦æå‰å®‰è£… C/C++ ç¼–è¯‘å™¨ã€Python å¼€å‘å¤´æ–‡ä»¶ã€`pkg-config`ã€Pango/Cairo å¼€å‘åº“ç­‰ã€‚æ­¤å¤–ï¼Œä¸ºé¿å…å®‰è£… tzdata æ—¶è¿›å…¥äº¤äº’å¼é…ç½®ï¼Œè¿˜éœ€è®¾ç½®ç›¸å…³ç¯å¢ƒå˜é‡ã€‚
- **å®‰è£… Python åŒ…**ï¼šé€šè¿‡ pip å®‰è£… Manim åŠå…¶ä¾èµ–ï¼ˆå¦‚ numpyã€moviepyã€requestsã€latex ç­‰ï¼‰ï¼Œå¹¶å•ç‹¬å®‰è£… manimpango ä»¥ä¿è¯ ManimPango æ„å»ºæˆåŠŸã€‚
- **æŒ‚è½½æœ¬åœ°è„šæœ¬ç›®å½•**ï¼šåˆ©ç”¨ Modal çš„ç›®å½•æŒ‚è½½åŠŸèƒ½ï¼Œå°†æœ¬åœ°å­˜æ”¾ Manim è„šæœ¬çš„ç›®å½•æŒ‚è½½åˆ°å®¹å™¨å†…ï¼Œç¡®ä¿æ¯æ¬¡è¿è¡Œæ—¶èƒ½è·å–æœ€æ–°ä»£ç ã€‚
- **å®‰è£… FFmpeg å’Œ LaTeX ç¯å¢ƒ**ï¼šManim æ¸²æŸ“éœ€è¦ FFmpeg æ¥åˆæˆè§†é¢‘æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨ LaTeX ç¯å¢ƒï¼ˆä¾‹å¦‚ texlive-fullï¼‰å¤„ç†æ•°å­¦å…¬å¼ã€‚Ubuntu 22.04 ä¸­çš„ FFmpeg é€šå¸¸æ”¯æŒ NVIDIA ç¡¬ä»¶åŠ é€Ÿï¼ˆNVENCï¼‰ï¼Œæ–¹ä¾¿åˆ©ç”¨ GPU è¿›è¡Œç¼–ç ã€‚
- **å®šä¹‰ Modal åº”ç”¨å’Œ GPU å‡½æ•°**ï¼šä½¿ç”¨ `@app.function(gpu="A10G")` æŒ‡å®šå‡½æ•°è¿è¡Œæ—¶åˆ†é… A10G GPUï¼ŒåŒæ—¶åœ¨å‡½æ•°å†…é€šè¿‡ `subprocess` æ£€æŸ¥ FFmpeg æ˜¯å¦å¯ç”¨äº† NVENCï¼Œå†è¯»å–å¹¶æ‰§è¡ŒæŒ‚è½½åœ¨å®¹å™¨å†…çš„ Manim è„šæœ¬ã€‚

ä¸‹æ–‡ç»™å‡ºå®Œæ•´çš„ä»£ç ç¤ºä¾‹ï¼Œå¹¶é™„ä¸Šè¯¦ç»†è¯´æ˜å’Œå‚è€ƒæ¥æºä¿¡æ¯ã€‚

---

## 1. é…ç½®æ”¯æŒ CUDA çš„åŸºç¡€é•œåƒ

ä¸ºäº†å……åˆ†åˆ©ç”¨ GPU èµ„æºï¼Œæˆ‘ä»¬é€‰æ‹© NVIDIA å®˜æ–¹çš„ CUDA å¼€å‘é•œåƒ `nvidia/cuda:12.2.0-devel-ubuntu22.04`ã€‚è¯¥é•œåƒå†…é¢„è£…äº† CUDA 12.2 çš„ç›¸å…³åº“ï¼Œé€‚ç”¨äºéœ€è¦ GPU åŠ é€Ÿçš„ä»»åŠ¡ã€‚åŒæ—¶é€šè¿‡ `add_python="3.10"` å®‰è£… Python ç¯å¢ƒã€‚è®¾ç½®ç¯å¢ƒå˜é‡ `DEBIAN_FRONTEND=noninteractive` ä¸ `TZ=Asia/Shanghai` å¯é¿å… tzdata åœ¨å®‰è£…æ—¶å¼¹å‡ºäº¤äº’æç¤ºï¼Œä»è€Œä¿è¯é•œåƒæ„å»ºçš„è‡ªåŠ¨åŒ–ã€‚

```python
import subprocess
import modal

image = (
  modal.Image.from_registry("nvidia/cuda:12.2.0-devel-ubuntu22.04", add_python="3.10")
  .env({"DEBIAN_FRONTEND": "noninteractive", "TZ": "Asia/Shanghai"})
```

> **å‚è€ƒè¯´æ˜**ï¼šé€‰æ‹© CUDA é•œåƒæ˜¯ä¸ºäº†ç¡®ä¿å®¹å™¨ä¸­æ‹¥æœ‰ GPU åŠ é€Ÿæ‰€å¿…éœ€çš„ CUDA åº“ï¼›åŒæ—¶è®¾ç½®æ—¶åŒºå’Œéäº¤äº’æ¨¡å¼ï¼ˆ[Modal Docs](https://modal.com/docs/reference/modal.Image)ï¼‰æœ‰åŠ©äºè‡ªåŠ¨åŒ–å®‰è£…è¿‡ç¨‹ã€‚

---

## 2. å®‰è£…ç³»ç»Ÿä¾èµ–ä¸ Python åŒ…

Manim åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­ä½¿ç”¨ **ManimPango**ï¼ˆPango çš„ Python ç»‘å®šï¼‰ï¼Œä½† Linux ä¸‹å¹¶æ²¡æœ‰é¢„ç¼–è¯‘çš„ wheel åŒ…ï¼Œå› æ­¤éœ€è¦åœ¨æ„å»ºå‰å®‰è£…ç¼–è¯‘å·¥å…·å’Œç›¸å…³ç³»ç»Ÿåº“ã€‚å®‰è£…å†…å®¹åŒ…æ‹¬ï¼š

- **tzdata**ï¼šè®¾ç½®æ—¶åŒºï¼Œé¿å…äº¤äº’å¼æç¤ºã€‚
- **build-essential**ã€**python3-dev**ã€**pkg-config**ï¼šç¼–è¯‘ C/C++ æ‰©å±•æ—¶å¿…å¤‡ã€‚
- **libcairo2-dev**ã€**libpango1.0-dev**ã€**clang**ï¼šæ”¯æŒ Pango/Cairo æ–‡æœ¬æ¸²æŸ“ï¼ˆå‚è§ [ManimCommunity/ManimPango](https://github.com/ManimCommunity/ManimPango)ï¼‰ã€‚
- **ffmpegã€ghostscriptã€dvisvgmã€texlive-full**ï¼šFFmpeg ç”¨äºè§†é¢‘ç¼–ç ï¼ˆUbuntu 22.04 ä¸­é€šå¸¸æ”¯æŒ NVENCï¼‰ï¼Œè€Œ LaTeX ç¯å¢ƒï¼ˆtexlive-fullï¼‰ç¡®ä¿ Tex/MathTex èƒ½æ­£å¸¸æ¸²æŸ“æ•°å­¦å…¬å¼ã€‚

åŒæ—¶ï¼Œå‡çº§ pipã€setuptools å’Œ wheel ç¡®ä¿åç»­å®‰è£…é¡ºåˆ©ï¼Œç„¶ååˆ©ç”¨ pip åˆ†åˆ«å®‰è£… `manim`ã€`numpy`ã€`latex`ã€`moviepy`ã€`requests` åŠ `manimpango`ã€‚

```python
  .apt_install("tzdata")
  .run_commands("ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && echo 'Asia/Shanghai' > /etc/timezone")
  .apt_install("build-essential", "ffmpeg", "ghostscript", "dvisvgm", "texlive-full")
  .apt_install("python3-dev", "pkg-config")
  .apt_install("libcairo2-dev", "libpango1.0-dev", "clang")
  .run_commands("pip install --upgrade pip setuptools wheel")
  .pip_install("numpy", "manim", "latex", "moviepy", "requests")
  .pip_install("manimpango")
```

> **èƒŒæ™¯è¯´æ˜**ï¼š
>
> - ManimPango çš„æ„å»ºéœ€è¦ä¾èµ– Pango å’Œ Cairo çš„å¼€å‘åº“ï¼Œå®‰è£…è¿™äº›ä¾èµ–èƒ½ç¡®ä¿ pip æ„å»ºè¿‡ç¨‹ä¸­ä¸ä¼šæŠ¥é”™ï¼ˆå‚è€ƒ [3b1b/manim issue](https://github.com/3b1b/manim/issues/1635)ï¼‰ã€‚
> - FFmpeg å®‰è£…åå¯åˆ©ç”¨ NVIDIA NVENC ç¼–ç å™¨å¯¹è§†é¢‘è¿›è¡Œç¡¬ä»¶åŠ é€Ÿï¼›Ubuntu 22.04 é»˜è®¤çš„ ffmpeg åŒ…é€šå¸¸å·²åŒ…å« NVENC æ”¯æŒï¼ˆå‚è§ [3b1b/manim å®˜æ–¹è¯´æ˜](https://github.com/3b1b/manim)ï¼‰ã€‚
> - texlive-full èƒ½å¤Ÿå®Œæ•´æ”¯æŒ LaTeX æ¸²æŸ“éœ€æ±‚ï¼Œé€‚ç”¨äº Manim ä¸­çš„æ•°å­¦å…¬å¼å’Œæ–‡æœ¬æ¸²æŸ“ã€‚

---

## 3. æ·»åŠ æœ¬åœ°è„šæœ¬ç›®å½•æŒ‚è½½

ä¸ºäº†ä¾¿äºç®¡ç†å’Œå®æ—¶æ›´æ–° Manim è„šæœ¬ï¼Œæˆ‘ä»¬å°†æœ¬åœ°çš„ `scripts` ç›®å½•æŒ‚è½½åˆ°å®¹å™¨çš„ `/scripts` ç›®å½•ä¸­ã€‚è¿™æ ·ï¼Œæ— éœ€é‡æ–°æ„å»ºé•œåƒå³å¯æ›´æ–°æ¸²æŸ“åœºæ™¯ã€‚

```python
  .add_local_dir("scripts", "/scripts")
)
```

> **æç¤º**ï¼šModal æ”¯æŒä½¿ç”¨ `add_local_dir` æ–¹æ³•æŒ‚è½½æœ¬åœ°ç›®å½•ï¼Œç¡®ä¿åœ¨å‡½æ•°è¿è¡Œæ—¶å®¹å™¨èƒ½è¯»å–æœ€æ–°çš„è„šæœ¬æ–‡ä»¶ã€‚

---

## 4. å®šä¹‰ Modal åº”ç”¨å’Œ GPU æ¸²æŸ“å‡½æ•°

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å®šä¹‰ Modal åº”ç”¨å’Œä¸€ä¸ª GPU æ¸²æŸ“å‡½æ•°ã€‚è¯¥å‡½æ•°ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š

- **æ£€æŸ¥ FFmpeg NVENC ç¼–ç æ”¯æŒ**ï¼šé€šè¿‡è¿è¡Œ `ffmpeg -encoders | grep nven` å‘½ä»¤ç¡®è®¤ NVIDIA ç¡¬ä»¶ç¼–ç å™¨æ˜¯å¦å¯ç”¨ã€‚
- **è¯»å–å¹¶æ‰§è¡Œ Manim è„šæœ¬**ï¼šä»æŒ‚è½½çš„ `/scripts` ç›®å½•è¯»å–æŒ‡å®šçš„ Manim è„šæœ¬ï¼ˆä¾‹å¦‚ `manim_a_plus_b.py`ï¼‰ï¼Œå¹¶ä½¿ç”¨ `exec` å‡½æ•°æ‰§è¡Œã€‚

```python
app = modal.App("example-run-local-script", image=image)

@app.function(gpu="A10G")
def run_script():
  result = subprocess.run("ffmpeg -encoders | grep nven", shell=True, capture_output=True, text=True)
  print(result.stdout)

  with open("/scripts/manim_a_plus_b.py", "r", encoding="utf-8") as f:
    script_content = f.read()
    print(script_content)
    exec(script_content, {'__name__': '__main__'})
  print("exec finished")
```

> **è¯¦ç»†è¯´æ˜**ï¼š
>
> - ä½¿ç”¨ `@app.function(gpu="A10G")` è¡¨æ˜è¯¥å‡½æ•°åœ¨è¿è¡Œæ—¶ä¼šåˆ†é…ä¸€å— A10G GPUï¼ˆ24GB æ˜¾å­˜ï¼‰ï¼Œä»¥æ»¡è¶³ GPU åŠ é€Ÿéœ€æ±‚ï¼ˆå‚è€ƒ [Modal GPU Docs](https://modal.com/docs/reference/modal.gpu)ï¼‰ã€‚
> - é€šè¿‡ `subprocess.run` æ‰§è¡Œ FFmpeg å‘½ä»¤ï¼Œå¯ä»¥ç›´è§‚æŸ¥çœ‹ NVENC ç¼–ç å™¨çš„è¾“å‡ºï¼ŒéªŒè¯ç¯å¢ƒæ­£ç¡®é…ç½®ã€‚
> - åˆ©ç”¨ `exec` æ‰§è¡Œè„šæœ¬æ—¶ï¼Œä¼ å…¥ `{'__name__': '__main__'}` ä¿è¯è„šæœ¬èƒ½æŒ‰ç…§ç‹¬ç«‹è¿è¡Œæ—¶çš„é€»è¾‘æ‰§è¡Œã€‚

---

## 5. å®Œæ•´ä»£ç ç¤ºä¾‹

ä»¥ä¸‹ä¸ºæ•´åˆä¸Šè¿°å„æ­¥éª¤åçš„å®Œæ•´ä»£ç ç¤ºä¾‹ï¼š

```python
import subprocess
import modal

image = (
  modal.Image.from_registry("nvidia/cuda:12.2.0-devel-ubuntu22.04", add_python="3.10")
  .env({"DEBIAN_FRONTEND": "noninteractive", "TZ": "Asia/Shanghai"})
  .apt_install("tzdata")
  .run_commands("ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && echo 'Asia/Shanghai' > /etc/timezone")
  .apt_install("build-essential", "ffmpeg", "ghostscript", "dvisvgm", "texlive-full")
  .apt_install("python3-dev", "pkg-config")
  .apt_install("libcairo2-dev", "libpango1.0-dev", "clang")
  .run_commands("pip install --upgrade pip setuptools wheel")
  .pip_install("numpy", "manim", "latex", "moviepy", "requests")
  .pip_install("manimpango")
  .add_local_dir("scripts", "/scripts")
)

app = modal.App("example-run-local-script", image=image)

@app.function(gpu="A10G")
def run_script():
  result = subprocess.run("ffmpeg -encoders | grep nven", shell=True, capture_output=True, text=True)
  print(result.stdout)

  with open("/scripts/manim_a_plus_b.py", "r", encoding="utf-8") as f:
    script_content = f.read()
    print(script_content)
    exec(script_content, {'__name__': '__main__'})
  print("exec finished")
```

---

## 6. éƒ¨ç½²ä¸è¿è¡Œæ•ˆæœ

å°†ä¸Šè¿°ä»£ç ä¿å­˜ä¸º `modal_run_with_manim_gpu.py`ï¼Œå¹¶ç¡®ä¿ä½ çš„ Manim è„šæœ¬ï¼ˆä¾‹å¦‚ `manim_a_plus_b.py`ï¼‰å­˜æ”¾åœ¨æœ¬åœ° `scripts` ç›®å½•ä¸­ã€‚æ¥ç€ï¼Œé€šè¿‡ä»¥ä¸‹å‘½ä»¤éƒ¨ç½²å¹¶è¿è¡Œè¯¥åº”ç”¨ï¼š

```bash
modal deploy modal_run_with_manim_gpu.py
modal run modal_run_with_manim_gpu.py::run_script
```

éƒ¨ç½²å’Œè¿è¡ŒæˆåŠŸåï¼Œä½ ä¼šçœ‹åˆ°ç±»ä¼¼å¦‚ä¸‹çš„æ—¥å¿—è¾“å‡ºï¼š

```
âœ“ Initialized. View run at https://modal.com/apps/kaizhao/main/ap-lVLdYTUBaxIlEVugzdYws8
âœ“ Created objects.
â”œâ”€â”€ ğŸ”¨ Created mount E:\code\java\project-litongjava\java-generative-manim\src\main\resources\modal\modal_run_with_manim_gpu.py
â”œâ”€â”€ ğŸ”¨ Created mount E:\code\java\project-litongjava\java-generative-manim\src\main\resources\modal\scripts
â””â”€â”€ ğŸ”¨ Created function run_script.

==========
== CUDA ==
==========
CUDA Version 12.2.0

Container image Copyright (c) 2016-2023, NVIDIA CORPORATION & AFFILIATES. All rights reserved.

This container image and its contents are governed by the NVIDIA Deep Learning Container License.
By pulling and using the container, you accept the terms and conditions of this license:
https://developer.nvidia.com/ngc/nvidia-deep-learning-container-license

A copy of this license is made available in this container at /NGC-DL-CONTAINER-LICENSE for your convenience.

 V....D h264_nvenc           NVIDIA NVENC H.264 encoder (codec h264)
 V..... nvenc                NVIDIA NVENC H.264 encoder (codec h264)
 V..... nvenc_h264           NVIDIA NVENC H.264 encoder (codec h264)
 V..... nvenc_hevc           NVIDIA NVENC hevc encoder (codec hevc)
 V....D hevc_nvenc           NVIDIA NVENC hevc encoder (codec hevc)
```

ä¸Šè¿°æ—¥å¿—æ˜¾ç¤ºï¼š

- Modal å¹³å°æˆåŠŸåˆå§‹åŒ–å¹¶åˆ›å»ºäº†ç›¸åº”çš„æŒ‚è½½ç›®å½•ä¸å‡½æ•°ã€‚
- å®¹å™¨å†…çš„ CUDA ç¯å¢ƒä¿¡æ¯ä»¥åŠ FFmpeg å¯¹ NVIDIA NVENC ç¼–ç å™¨çš„æ”¯æŒæƒ…å†µå‡å·²æ­£ç¡®è¾“å‡ºï¼Œè¯æ˜ç¯å¢ƒé…ç½®æ­£ç¡®ï¼Œå¯ä»¥åˆ©ç”¨ GPU åŠ é€Ÿè¿›è¡Œè§†é¢‘ç¼–ç å’Œæ¸²æŸ“ã€‚

---

## æ€»ç»“

é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œæˆ‘ä»¬å®Œæˆäº†åœ¨ Modal å¹³å°ä¸ŠåŸºäº GPUï¼ˆA10Gï¼‰è¿è¡Œ Manim 0.18.1 è„šæœ¬çš„å®Œæ•´é…ç½®å·¥ä½œã€‚æ•´ä¸ªæµç¨‹ä¸­æˆ‘ä»¬ï¼š

- é€‰å–äº†åˆé€‚çš„ CUDA åŸºç¡€é•œåƒå¹¶é…ç½®äº† Python ç¯å¢ƒï¼›
- å®‰è£…äº†æ„å»º ManimPango å’Œæ¸²æŸ“è§†é¢‘æ‰€éœ€çš„ç³»ç»Ÿä¾èµ–ï¼ˆç¼–è¯‘å·¥å…·ã€Pango/Cairo åº“ã€FFmpegã€LaTeX ç­‰ï¼‰ï¼›
- å‡çº§äº† pip å·¥å…·å¹¶å®‰è£…äº†å¿…è¦çš„ Python åŒ…ï¼›
- åˆ©ç”¨ Modal çš„ç›®å½•æŒ‚è½½åŠŸèƒ½å®ç°äº†æœ¬åœ°è„šæœ¬ä¸å®¹å™¨çš„æ— ç¼å¯¹æ¥ï¼›
- å®šä¹‰äº†ä¸€ä¸ª GPU å‡½æ•°ï¼Œæ£€æµ‹ç¡¬ä»¶ç¼–ç æ”¯æŒå¹¶æ‰§è¡Œ Manim è„šæœ¬ã€‚

å‚è€ƒäº† Modal å®˜æ–¹æ–‡æ¡£ã€ManimCommunity/ManimPango ä»¥åŠ 3Blue1Brown çš„ Manim é¡¹ç›®è¯´æ˜ï¼Œè¿™æ ·çš„é…ç½®ä¸ä»…ç¡®ä¿äº†ç¯å¢ƒçš„ä¸€è‡´æ€§ï¼Œè¿˜å……åˆ†åˆ©ç”¨äº† GPU åŠ é€Ÿæ¸²æŸ“çš„ä¼˜åŠ¿ã€‚å¸Œæœ›è¿™ä»½æ–‡æ¡£èƒ½å¸®åŠ©ä½ æ·±å…¥ç†è§£å¹¶é¡ºåˆ©éƒ¨ç½²è‡ªå·±çš„äº‘ç«¯ Manim æ¸²æŸ“åº”ç”¨ã€‚
