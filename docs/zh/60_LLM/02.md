# æµå¼ç”Ÿæˆï¼ˆStreaming Generationï¼‰

åœ¨å®é™…ä¸šåŠ¡ä¸­ï¼Œå¾ˆå¤šåœºæ™¯å¹¶ä¸é€‚åˆâ€œç­‰å¾…å®Œæ•´ç»“æœä¸€æ¬¡æ€§è¿”å›â€ï¼Œä¾‹å¦‚ï¼š

* èŠå¤©æœºå™¨äººé€å­—è¾“å‡ºï¼Œæå‡äº¤äº’ä½“éªŒ
* é•¿æ–‡æœ¬ç”Ÿæˆï¼ˆå†™ä½œã€æ€»ç»“ã€ä»£ç ç”Ÿæˆï¼‰ï¼Œé™ä½é¦– token å»¶è¿Ÿ
* Web å‰ç«¯ä½¿ç”¨ SSE / WebSocket å®æ—¶æ¸²æŸ“å†…å®¹
* é¿å…é•¿æ—¶é—´é˜»å¡è¯·æ±‚å¯¼è‡´çš„è¶…æ—¶é—®é¢˜

`java-openai` åœ¨ç»Ÿä¸€æŠ½è±¡å±‚ä¹‹ä¸Šï¼Œæä¾›äº†**è·¨å¹³å°ä¸€è‡´çš„æµå¼ç”Ÿæˆèƒ½åŠ›**ã€‚ä¸šåŠ¡ä¾§åªéœ€è¦ï¼š

* æ„é€  `UniChatRequest`
* æ³¨å†Œ `UniChatEventListener`
* è°ƒç”¨ `UniChatClient.stream(...)`

å³å¯è·å¾—ç»Ÿä¸€çš„æµå¼å›è°ƒï¼Œè€Œæ— éœ€å…³å¿ƒ OpenAI / Google / Anthropic / OpenRouter ç­‰å¹³å°åœ¨æµå¼åè®®ä¸Šçš„å·®å¼‚ã€‚

---

## åŸºæœ¬æ€è·¯

æµå¼ç”Ÿæˆçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š

1. å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ï¼ˆé€šå¸¸æ˜¯ HTTP + SSEï¼‰
2. `UniChatClient` ä»¥æµå¼æ¨¡å¼è¯·æ±‚å¤§æ¨¡å‹å¹³å°
3. åº•å±‚å¹³å°ä¸æ–­è¿”å› **å¢é‡å†…å®¹ï¼ˆdeltaï¼‰**
4. `java-openai` å°†ä¸åŒå¹³å°çš„å¢é‡æ•°æ®ç»Ÿä¸€æ˜ å°„ä¸º `UniChatResponse.delta`
5. ä¸šåŠ¡ä¾§åœ¨ `onData` å›è°ƒä¸­æ¶ˆè´¹å¢é‡å†…å®¹å¹¶æ¨é€ç»™å®¢æˆ·ç«¯

**å…³é”®ç‚¹ï¼š**

> åœ¨æµå¼ç”Ÿæˆåœºæ™¯ä¸­ï¼Œè·å–å¤§æ¨¡å‹è¾“å‡ºåº”ä½¿ç”¨
> `chatResponse.getDelta()`ï¼Œè€Œä¸æ˜¯ `chatResponse.getMessage()`ã€‚

---

## ç¤ºä¾‹ï¼šåŸºäº SSE çš„æµå¼æ¥å£

ä¸‹é¢ç¤ºä¾‹å±•ç¤ºäº†ä¸€ä¸ªå®Œæ•´çš„ SSE æµå¼æ¥å£å®ç°ï¼ŒåŸºäº Tio HTTP Serverã€‚

### ç¤ºä¾‹ä»£ç 

```java
package com.litongjava.tio.web.hello.handler;

import java.util.ArrayList;
import java.util.List;

import com.litongjava.chat.PlatformInput;
import com.litongjava.chat.UniChatClient;
import com.litongjava.chat.UniChatEventListener;
import com.litongjava.chat.UniChatMessage;
import com.litongjava.chat.UniChatRequest;
import com.litongjava.chat.UniChatResponse;
import com.litongjava.consts.ModelPlatformName;
import com.litongjava.openrouter.OpenRouterModels;
import com.litongjava.tio.boot.http.TioRequestContext;
import com.litongjava.tio.core.ChannelContext;
import com.litongjava.tio.core.Tio;
import com.litongjava.tio.http.common.HttpRequest;
import com.litongjava.tio.http.common.HttpResponse;
import com.litongjava.tio.http.common.sse.SsePacket;
import com.litongjava.tio.http.server.handler.HttpRequestHandler;
import com.litongjava.tio.http.server.util.SseEmitter;

import okhttp3.Response;
import okhttp3.sse.EventSource;

public class PredictStreamHandler implements HttpRequestHandler {

  @Override
  public HttpResponse handle(HttpRequest httpRequest) throws Exception {
    // 1. æŒ‡å®šå¹³å°ä¸æ¨¡å‹
    PlatformInput platform = new PlatformInput(
        ModelPlatformName.OPENROUTER,
        OpenRouterModels.XIAOMI_MIMO_V2_FLASH_FREE
    );

    // 2. æ„é€ æ¶ˆæ¯
    List<UniChatMessage> messges = new ArrayList<>();
    messges.add(UniChatMessage.buildUser("just say hi"));

    // 3. æ„é€ ç»Ÿä¸€è¯·æ±‚
    UniChatRequest uniChatRequest = new UniChatRequest(platform);
    uniChatRequest.setMessages(messges);

    // 4. å‡†å¤‡ SSE å“åº”
    HttpResponse httpResponse = TioRequestContext.getResponse();
    // æŒ‡å®štio-boot dispathher handler æ”¶åˆ°æ”¹è¯·æ±‚åä¸å‘é€ç»™å®¢æˆ·ç«¯,å› ä¸ºåé¢éœ€è¦å†onOpenæ—¶æ‰‹åŠ¨å‘é€
    httpResponse.setSend(false);

    ChannelContext ctx = httpRequest.channelContext;

    // 5. æ³¨å†Œæµå¼äº‹ä»¶ç›‘å¬å™¨
    UniChatEventListener listener = new UniChatEventListener() {

      @Override
      public void onOpen(EventSource eventSource, Response response) {
        // å»ºç«‹ SSE è¿æ¥
        httpResponse.addServerSentEventsHeader();
        Tio.send(ctx, httpResponse);
      }

      @Override
      public void onData(UniChatResponse chatResposne) {
        // æµå¼å¢é‡å†…å®¹ä» delta ä¸­è·å–
        String content = chatResposne.getDelta().getContent();
        Tio.bSend(ctx, new SsePacket(content));
      }

      @Override
      public void onClosed(EventSource eventSource) {
        // å…³é—­ SSE è¿æ¥
        SseEmitter.closeSeeConnection(ctx);
      }
    };

    // 6. å‘èµ·æµå¼è¯·æ±‚
    UniChatClient.stream(uniChatRequest, listener);

    return httpResponse;
  }
}
```

---

## å®¢æˆ·ç«¯è°ƒç”¨ç¤ºä¾‹

ä½¿ç”¨ `curl` ç›´æ¥è®¿é—®æµå¼æ¥å£ï¼š

```bash
curl http://localhost/predict/stream
```

ç¤ºä¾‹è¾“å‡ºï¼š

```text
data:

data:Hi

data: there

data:!

data:ğŸ˜Š

data: How can

data: I help

data: you

data: today?

data:

data:
```

å¯ä»¥çœ‹åˆ°ï¼Œå¤§æ¨¡å‹çš„å›å¤è¢«æ‹†åˆ†æˆå¤šä¸ªç‰‡æ®µï¼Œé€æ¡é€šè¿‡ SSE æ¨é€ç»™å®¢æˆ·ç«¯ã€‚

---

## æ ¸å¿ƒè¦ç‚¹è¯´æ˜

### 1. ä¸ºä»€ä¹ˆä½¿ç”¨ `getDelta()` è€Œä¸æ˜¯ `getMessage()`

åœ¨ `java-openai` çš„ç»Ÿä¸€æ¨¡å‹ä¸­ï¼š

* **éæµå¼è¯·æ±‚**

  * è¿”å›ä¸€æ¬¡å®Œæ•´ç»“æœ
  * ä½¿ç”¨ `UniChatResponse.message`
* **æµå¼è¯·æ±‚**

  * æ¯æ¬¡å›è°ƒåªåŒ…å«â€œæ–°å¢çš„ä¸€å°æ®µå†…å®¹â€
  * ä½¿ç”¨ `UniChatResponse.delta`

å› æ­¤ï¼š

* `chatResponse.getMessage()`

  * é€‚ç”¨äº `UniChatClient.generate(...)`
* `chatResponse.getDelta()`

  * é€‚ç”¨äº `UniChatClient.stream(...)`

è¿™æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„åŒºåˆ†ç‚¹ã€‚

---

### 2. UniChatEventListener ç”Ÿå‘½å‘¨æœŸ

`UniChatEventListener` é€šå¸¸åŒ…å«ä¸‰ä¸ªå…³é”®å›è°ƒï¼š

* `onOpen(...)`
  æµå¼è¿æ¥å»ºç«‹æˆåŠŸã€‚
  åœ¨è¿™é‡Œåˆå§‹åŒ– SSE å¤´ã€å‘é€é¦–æ¬¡å“åº”ã€‚

* `onData(UniChatResponse response)`
  æ¯æ”¶åˆ°ä¸€æ¬¡æ¨¡å‹çš„å¢é‡è¾“å‡ºï¼Œå°±ä¼šè§¦å‘ä¸€æ¬¡ã€‚
  **ä¸šåŠ¡åº”åœ¨è¿™é‡Œæ¶ˆè´¹ `response.getDelta()` å¹¶å‘å‰ç«¯æ¨é€ã€‚**

* `onClosed(...)`
  æµå¼ç”Ÿæˆç»“æŸæˆ–è¿æ¥å…³é—­ã€‚
  ç”¨äºé‡Šæ”¾èµ„æºã€å…³é—­ SSE è¿æ¥ã€‚

---

### 3. å¹³å°å·®å¼‚çš„å±è”½

ä¸åŒå¹³å°åœ¨æµå¼è¿”å›ä¸Šçš„å·®å¼‚å¾ˆå¤§ï¼Œä¾‹å¦‚ï¼š

* OpenAIï¼šdelta.content
* Anthropicï¼šcontent block
* Googleï¼šparts / text fragments
* OpenRouterï¼šèšåˆå¤šç§å¹³å°è¿”å›æ ¼å¼

è¿™äº›å·®å¼‚å…¨éƒ¨ç”± `UniChatClient` å†…éƒ¨å¤„ç†å¹¶ç»Ÿä¸€æ˜ å°„ä¸ºï¼š

```java
UniChatResponse.delta
```

ä¸šåŠ¡ä¾§åªéœ€è¦å¤„ç†ä¸€ç§ç»“æ„ã€‚

---

## é€‚ç”¨åœºæ™¯å»ºè®®

æ¨èåœ¨ä»¥ä¸‹åœºæ™¯ä¸­ä½¿ç”¨æµå¼ç”Ÿæˆï¼š

* èŠå¤©æœºå™¨äºº / AI åŠ©æ‰‹
* å®æ—¶å†™ä½œã€æ¶¦è‰²ã€ç¿»è¯‘
* ä»£ç è¡¥å…¨ä¸ç”Ÿæˆ
* é•¿æ–‡æœ¬æ‘˜è¦æˆ–æŠ¥å‘Šç”Ÿæˆ
* Web UI å¼ºäº¤äº’åœºæ™¯

è€Œåœ¨ä»¥ä¸‹åœºæ™¯ä¸­ï¼Œéæµå¼æ›´åˆé€‚ï¼š

* éœ€è¦ä¸€æ¬¡æ€§å®Œæ•´ JSON ç»“æ„è¾“å‡º
* åå°ä»»åŠ¡æˆ–æ‰¹å¤„ç†
* å¯¹å“åº”é¡ºåºå’Œå®Œæ•´æ€§è¦æ±‚æé«˜çš„ç³»ç»Ÿæ¥å£

---

## å°ç»“

* `java-openai` æä¾›äº†ç»Ÿä¸€çš„è·¨å¹³å°æµå¼ç”Ÿæˆèƒ½åŠ›
* æµå¼åœºæ™¯ä¸‹ï¼Œ**å¿…é¡»ä½¿ç”¨ `UniChatResponse.getDelta()` è·å–æ¨¡å‹è¾“å‡º**
* `UniChatClient.stream(...)` + `UniChatEventListener` æ˜¯æ ‡å‡†ä½¿ç”¨æ–¹å¼
* SSE / WebSocket / å…¶ä»–æ¨é€æœºåˆ¶éƒ½å¯ä»¥åœ¨ç›‘å¬å™¨ä¸­è‡ªç”±ç»„åˆ
