# Tio Boot + Enjoy：分页与 SEO 实战指南

## 背景与目的

在构建现代 Web 应用时，我们往往需要同时兼顾 **性能**、**用户体验** 和 **搜索引擎优化 (SEO)**。

* **性能**：后端要能高效分页，避免一次性返回海量数据，保证前端加载流畅；
* **用户体验**：分页导航要直观、简洁，支持键盘快捷键与自定义每页大小；
* **SEO**：页面内容应能被搜索引擎爬虫直接识别，不依赖复杂的 JavaScript 动态渲染。

本文面向使用 **Tio Boot 框架** 与 **Enjoy 模板引擎** 的开发者，提供一套完整的**分页实现方案**：

1. **后端**

   * 使用 `Db.paginate` 与 `Page<T>` 封装查询结果；
   * 提供总页数、总记录数等分页元信息；
   * 支持 `/{pageNo}?/{pageSize}?` 路由，灵活访问 `/` 或指定分页地址；

2. **前端模板**

   * 首页使用 `<a>` 卡片链接而非 `onclick`，让搜索引擎可直接抓取；
   * 支持分页条、总页数/总记录数显示；
   * 提供响应式布局和键盘快捷翻页。

3. **SEO 优化**

   * 链接静态化（如 `/preview/123`）；
   * 首页卡片内容可被直接爬取；
   * 模板中包含 `<title>` 与 `<meta description>`，利于搜索引擎收录。

通过本文，你可以快速为自己的 Tio Boot 项目增加一个 **可分页、可被搜索引擎收录** 的首页与预览页面，兼顾用户体验与 SEO 效果。


接下来的章节，逐步介绍 **拦截器与路由配置**、**Handler**、**Service 分页逻辑**、**首页模板 index.html**、以及可选的 **预览页优化**。


---

## 1. 拦截器与路由配置

### 1.1 放行规则（支持可选段）

将首页与详情页加入白名单，且首页支持 `/{pageNo}?/{pageSize}?` 可选段（`?` 表示该段可省略，末尾连续可选）。

```java
// Tio Boot Enjoy SEO
String[] permitUrls = { "/", "/{pageNo}?/{pageSize}?", "/preview/**", "/ping"};
new TioAdminInterceptorConfiguration(permitUrls).config();
```

> 这样即可避免使用 `/**` 大范围放行，精确授权首页与预览页。

### 1.2 路由（只需两条）

首页 1 条路由即可覆盖 `/` 与 `/pageNo/pageSize`；预览页按 ID 访问：

```java
HttpRequestRouter r = server.getRequestRouter();
VideoPageHandler videoPageHandler = new VideoPageHandler();
r.add("/{pageNo}?/{pageSize}?", videoPageHandler::index);
r.add("/preview/{id}", videoPageHandler::preview);
```

> 若你希望页码/页大小必须为数字，可写成：
> `/ {pageNo:\d+}? / {pageSize:\d+}?`

---

## 2. Handler：接收可选段参数并渲染页面

`VideoPageHandler` 从路由注入的 `pageNo/pageSize/id` 中取值（不存在则用默认值），调用 Service 渲染 HTML。

```java
package com.litongjava.manim.handler;

import com.litongjava.jfinal.aop.Aop;
import com.litongjava.manim.services.VideoPageService;
import com.litongjava.tio.boot.http.TioRequestContext;
import com.litongjava.tio.http.common.HttpRequest;
import com.litongjava.tio.http.common.HttpResponse;
import com.litongjava.tio.http.server.util.Resps;

import lombok.extern.slf4j.Slf4j;

@Slf4j
public class VideoPageHandler {

  VideoPageService srv = Aop.get(VideoPageService.class);

  public HttpResponse index(HttpRequest request) {
    HttpResponse response = TioRequestContext.getResponse();

    Integer pageNo = null;
    Integer pageSize = null;
    try {
      pageNo = request.getInt("pageNo", 1);
      pageSize = request.getInt("pageSize", 10);
    } catch (Exception e) {
      return null; // 返回 null 交由后续链路（如 404/500）处理
    }

    VideoPageService indexService = Aop.get(VideoPageService.class);
    String html = indexService.index(pageNo, pageSize);
    Resps.html(response, html);
    return response;
  }

  public HttpResponse preview(HttpRequest request) {
    Long id = request.getLong("id");
    HttpResponse response = TioRequestContext.getResponse();
    String html = srv.getPreviewHtmlById(id);
    return Resps.html(response, html);
  }
}
```

---

## 3. Service：分页查询与模板变量注入

利用已有的 `Page<T>` 与 `Db.paginate(...)`，一次性把分页变量（如 `totalPage/totalRow/hasPrev/hasNext` 等）注入模板，页面逻辑更简洁。

```java
package com.litongjava.manim.services;

import java.util.List;

import com.jfinal.kit.Kv;
import com.litongjava.db.SqlPara;
import com.litongjava.db.activerecord.Db;
import com.litongjava.db.activerecord.Row;
import com.litongjava.jfinal.aop.Aop;
import com.litongjava.manim.consts.EfTableName;
import com.litongjava.model.page.Page;
import com.litongjava.template.EnjoyTemplate;

public class VideoPageService {

  VideoService videoService = Aop.get(VideoService.class);

  /** 渲染首页 */
  public String index(int pageNo, int pageSize) {
    pageNo  = Math.max(1, pageNo);
    pageSize = Math.max(1, pageSize);

    // 注意：Db.paginate 会自动拼接 limit/offset
    String sql = "select id,topic,language,view_count,create_time from %s where video_url is not null order by id";
    sql = String.format(sql, EfTableName.ef_generated_video);
    SqlPara sqlPara = SqlPara.by(sql);

    Page<Row> page = Db.paginate(pageNo, pageSize, sqlPara);
    List<Row> data = page.getList();

    int pn = page.getPageNumber();
    int ps = page.getPageSize();
    int tp = page.getTotalPage();
    int tr = page.getTotalRow();

    boolean hasPrev = pn > 1;
    boolean hasNext = pn < Math.max(1, tp);

    int prevPage = hasPrev ? (pn - 1) : 1;
    int nextPage = hasNext ? (pn + 1) : pn;

    Kv kv = Kv.by("data", data)
        .set("pageNo", pn).set("pageSize", ps)
        .set("totalPage", tp).set("totalRow", tr)
        .set("hasPrev", hasPrev).set("hasNext", hasNext)
        .set("prevPage", prevPage).set("nextPage", nextPage);

    return EnjoyTemplate.renderToString("index.html", kv);
  }

  /** 渲染预览页 */
  public String getPreviewHtmlById(Long id) {
    Row row = Db.findById(EfTableName.ef_generated_video, id);
    Kv kv;
    if (row != null) {
      kv = row.toKv();
      videoService.convert(kv);
      kv.set("answer", Aop.get(AnswerService.class).queryAnserById(id));
      List<String> transcript = Aop.get(ManimSceneCodeService.class).getTranscriptByGroupId(id);
      String subTitle = String.join("", transcript);
      kv.set("transcript", subTitle);
    } else {
      kv = Kv.by("title", "Not Found");
    }
    return EnjoyTemplate.renderToString("preview.html", kv);
  }
}
```

> 若要最新在前，SQL 改为 `order by id desc`；
> 模板变量 `totalPage` 与 `totalRow` 已注入，可直接用于显示。

---

## 4. 首页模板：`index.html`（可爬取 + 分页）

* 卡片改为 `<a>`，便于 SEO 爬取与可访问性。
* 底部分页条直接跳转 `/{pageNo}/{pageSize}`。
* 文末显示当前页、总页、总条。

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study11 Learning Platform</title>
    <meta name="description" content="Study11 — Explaining knowledge through animations. Browse generated videos with topics and languages.">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            min-height:100vh; padding:20px;
        }
        .container { max-width:1200px; margin:0 auto; }
        .header { text-align:center;}
        .header h1 {
            color:#fff; font-size:2.5rem; margin-bottom:10px;
            text-shadow:2px 2px 4px rgba(0,0,0,.3);
        }
        .header p { color:rgba(255,255,255,.9); font-size:1.1rem; max-width:600px; margin:0 auto; }

        .content-grid {
            display:grid; grid-template-columns:repeat(auto-fit,minmax(350px,1fr));
            gap:25px; padding:20px 0;
        }

        /* 卡片为 <a>，方便 SEO */
        .card {
            display:block;
            background:#fff; border-radius:15px; padding:25px;
            box-shadow:0 10px 30px rgba(0,0,0,.15);
            transition:all .3s ease; position:relative; overflow:hidden;
            text-decoration:none; color:inherit; cursor:pointer;
        }
        .card:hover { transform: translateY(-5px); box-shadow:0 15px 40px rgba(0,0,0,.25); }
        .card::before { content:''; position:absolute; top:0; left:0; right:0; height:4px;
            background:linear-gradient(90deg,#667eea,#764ba2); }

        .card-title {
            font-size:1.4rem; color:#333; margin-bottom:15px; line-height:1.4; transition:color .3s ease;
            white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
        }
        .card:hover .card-title { color:#667eea; }

        .card-meta {
            display:flex; justify-content:space-between; align-items:center;
            margin-top:20px; padding-top:15px; border-top:1px solid #eee;
        }
        .card-language {
            background:linear-gradient(45deg,#667eea,#764ba2); color:#fff;
            padding:6px 12px; border-radius:20px; font-size:.85rem; font-weight:500;
        }
        .card-views { color:#666; font-size:.9rem; display:flex; align-items:center; gap:5px; }
        .card-time { color:#999; font-size:.85rem; margin-top:8px; font-style:italic; }

        .empty-state { text-align:center; color:#fff; padding:60px 20px; grid-column:1 / -1; }
        .empty-state h2 { font-size:1.5rem; margin-bottom:10px; }

        @media (max-width:768px) {
            .content-grid { grid-template-columns:1fr; gap:20px; }
            .header h1 { font-size:2rem; }
            .card { padding:20px; }
        }
        .view-icon { width:16px; height:16px; display:inline-block; vertical-align:middle; margin-right:5px; }

        /* 分页条 */
        .pagination {
          display:flex; gap:10px; justify-content:center; align-items:center;
          margin: 24px 0 8px;
        }
        .pag-btn {
          padding:8px 14px; border:0; border-radius:10px; cursor:pointer;
          background:#fff; box-shadow:0 6px 18px rgba(0,0,0,.12);
          font-weight:600; transition: transform .15s ease, box-shadow .15s ease;
          text-decoration:none; color:#333;
        }
        .pag-btn:hover { transform: translateY(-2px); box-shadow:0 10px 24px rgba(0,0,0,.18); }
        .pag-btn[disabled] { opacity:.45; cursor:not-allowed; transform:none; box-shadow:none; }
        .page-info { color:#fff; font-size:.95rem; margin:6px 0 0; text-align:center; opacity:.9; }
        .size-select {
          padding:8px 10px; border-radius:10px; border:0; outline:none;
          box-shadow:0 6px 18px rgba(0,0,0,.12); background:#fff; font-weight:600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Study11 Learning Platform</h1>
            <p>Explaining knowledge through animations</p>
        </div>

        <div class="content-grid">
            #if(data && data.size() > 0)
                #for(item : data)
                <a class="card" href="/preview/#(item.id)" aria-label="Open #(item.topic)">
                    <h3 class="card-title">#(item.topic)</h3>
                    <div class="card-time">Created: #date(item.create_time, "yyyy-MM-dd HH:mm:ss")</div>
                    <div class="card-meta">
                        <span class="card-language">#(item.language??"Unknown")</span>
                        <span class="card-views">
                            <svg class="view-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                                <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                            </svg>
                            #(item.view_count??0) views
                        </span>
                    </div>
                </a>
                #end
            #else
                <div class="empty-state">
                    <h2>No Data Available</h2>
                    <p>There is no learning content yet. Please check back later.</p>
                </div>
            #end
        </div>

        <!-- 分页条 -->
        <div class="pagination">
          #if(hasPrev)
            <a class="pag-btn" href="/#(prevPage)/#(pageSize)">← Prev</a>
          #else
            <button class="pag-btn" disabled>← Prev</button>
          #end

          <span class="pag-btn" style="pointer-events:none;">Page&nbsp;#(pageNo)</span>

          #if(hasNext)
            <a class="pag-btn" href="/#(nextPage)/#(pageSize)">Next →</a>
          #else
            <button class="pag-btn" disabled>Next →</button>
          #end

          <select id="sizeSelect" class="size-select" onchange="onPageSizeChange(this.value)">
            <option value="10"  #(pageSize==10  ? 'selected' : '')>10 / page</option>
            <option value="20"  #(pageSize==20  ? 'selected' : '')>20 / page</option>
            <option value="50"  #(pageSize==50  ? 'selected' : '')>50 / page</option>
            <option value="100" #(pageSize==100 ? 'selected' : '')>100 / page</option>
          </select>
        </div>
        <p class="page-info">
          Page #(pageNo) of #(totalPage) &nbsp; | &nbsp;
          Total #(totalRow) records
        </p>
    </div>

    <script>
        // 仅负责 hover 动画
        document.addEventListener('DOMContentLoaded', function() {
            const cards = document.querySelectorAll('.card');
            cards.forEach(card => {
                card.addEventListener('mouseenter', function(){ this.style.transform = 'translateY(-5px)'; });
                card.addEventListener('mouseleave', function(){ this.style.transform = 'translateY(0)'; });
            });
        });

        function onPageSizeChange(size){
          var pageNo = #(pageNo);
          var s = parseInt(size,10) || 10;
          location.href = '/' + pageNo + '/' + s;
        }

        // 键盘 ← → 快捷翻页（可选）
        document.addEventListener('keydown', function(e){
          if (e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.isContentEditable)) return;
          if (e.key === 'ArrowLeft'  && #(hasPrev)) location.href = '/#(prevPage)/#(pageSize)';
          if (e.key === 'ArrowRight' && #(hasNext)) location.href = '/#(nextPage)/#(pageSize)';
        });
    </script>
</body>
</html>
```

---

## 5. 预览页

`preview.html`，建议做到：

* `<a href="/preview/{id}">` 能 SSR 渲染出可索引的 200 HTML（你现在就是）；
* `<title>` 与 `<meta name="description">` 使用 `title/description` 模板变量；
* 可选地加 `<link rel="canonical" href="/preview/{id}">` 和结构化数据（`VideoObject`），利于收录。

---
## 7. 结语

* **后端**：`Db.paginate + Page<T>` → 注入 `pageNo/pageSize/totalPage/totalRow/hasPrev/hasNext`；
* **路由**：一条 `/{pageNo}?/{pageSize}?` 覆盖 `/` 与分页；
* **前端**：卡片使用 `<a>`，分页跳转即刻生效，底部显示“第几页 / 总页数 / 总条数”。

